<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbound Control Tower</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base Styles */
        body { 
            background-color: #F0F4F8; 
            color: #334155; 
            font-size: 13px; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-image: radial-gradient(#E2E8F0 1px, transparent 1px); 
            background-size: 24px 24px; 
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* Card Styles */
        .fresh-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border-radius: 20px; 
            border: 1px solid #FFFFFF; 
            box-shadow: 0 4px 20px -2px rgba(148, 163, 184, 0.15); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .fresh-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 30px -5px rgba(148, 163, 184, 0.2); 
        }

        /* Inputs */
        .fresh-input { 
            background: #F8FAFC; 
            border: 1px solid #E2E8F0; 
            border-radius: 12px; 
            padding: 8px 12px; 
            font-size: 12px; 
            font-weight: 500; 
            color: #334155; 
            outline: none; 
            transition: all 0.2s; 
        }
        .fresh-input:focus { 
            background: #FFFFFF; 
            border-color: #6366F1; 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); 
        }

        /* Buttons */
        .btn-gradient { 
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%); 
            color: white; 
            padding: 8px 16px; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 12px; 
            transition: all 0.3s; 
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .btn-gradient:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35); 
            filter: brightness(1.1); 
        }

        .btn-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
            padding: 8px 16px; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 12px; 
            transition: all 0.3s; 
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .btn-danger:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.35); 
            filter: brightness(1.1); 
        }

        .btn-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: white; 
            padding: 8px 16px; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 12px; 
            transition: all 0.3s; 
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.25); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .btn-warning:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.35); 
            filter: brightness(1.1); 
        }

        /* Toggles */
        .pill-toggle { 
            padding: 6px 14px; 
            border-radius: 50px; 
            font-size: 11px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            border: 1px solid transparent; 
        }
        .pill-active { 
            background: #0f172a; 
            color: #ffffff; 
            border-color: #0f172a; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
        }
        .pill-inactive { 
            background: #FFFFFF; 
            color: #64748B; 
            border-color: #E2E8F0; 
        }
        .pill-inactive:hover { 
            background: #F8FAFC; 
            color: #334155; 
        }

        /* Table */
        .fresh-table th { 
            text-transform: uppercase; 
            font-size: 10px; 
            font-weight: 700; 
            color: #64748B; 
            letter-spacing: 0.05em; 
            padding: 14px 16px; 
            background: #F8FAFC; 
            border-bottom: 2px solid #94a3b8; 
        }
        .fresh-table td { 
            padding: 12px 16px; 
            border-bottom: 1px solid #cbd5e1; /* Default Border */
            color: #334155; 
            vertical-align: top; 
        }
        
        /* Specific Styles for Merged Cells */
        .valign-middle {
            vertical-align: middle !important;
        }

        .fresh-table tr:hover td { background-color: #F1F5F9; }
        .group-col { background-color: #FFFFFF; border-right: 1px solid #cbd5e1; }
        
        /* BORDERS: Specific Thickness Logic */
        .border-date-group { border-top: 3px solid #1e293b !important; } /* Hitam/Gelap Tebal untuk Tanggal */
        .border-dest-group { border-top: 2px solid #64748b !important; } /* Abu Tebal untuk Destinasi */
        .thick-date-border { border-top: 4px solid #334155 !important; }

        /* Animations */
        @keyframes slideDown { from { transform: translate(-50%, -150%); opacity: 0; } to { transform: translate(-50%, 20px); opacity: 1; } }
        .toast-animate { animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out; }
        @keyframes fadeInUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .input-label { display: block; font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 4px; margin-left: 2px; }
        
        /* Sticky Filter Background Fix */
        .sticky-filter-wrapper {
            position: sticky;
            top: 72px; /* Adjust based on header height */
            z-index: 30;
            background-color: #F0F4F8; /* Matches body background */
            margin-left: -1rem; /* Counteract container padding */
            margin-right: -1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(8px);
        }

        /* From Uiverse.io by vinodjangid07 */ 
        .loader {
          width: fit-content;
          height: fit-content;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .truckWrapper {
          width: 200px;
          height: 100px;
          display: flex;
          flex-direction: column;
          position: relative;
          align-items: center;
          justify-content: flex-end;
          overflow-x: hidden;
        }
        /* truck upper body */
        .truckBody {
          width: 130px;
          height: fit-content;
          margin-bottom: 6px;
          animation: motion 1s linear infinite;
        }
        /* truck suspension animation*/
        @keyframes motion {
          0% {
            transform: translateY(0px);
          }
          50% {
            transform: translateY(3px);
          }
          100% {
            transform: translateY(0px);
          }
        }
        /* truck's tires */
        .truckTires {
          width: 130px;
          height: fit-content;
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 0px 10px 0px 15px;
          position: absolute;
          bottom: 0;
        }
        .truckTires svg {
          width: 24px;
        }

        .road {
          width: 100%;
          height: 1.5px;
          background-color: #282828;
          position: relative;
          bottom: 0;
          align-self: flex-end;
          border-radius: 3px;
        }
        .road::before {
          content: "";
          position: absolute;
          width: 20px;
          height: 100%;
          background-color: #282828;
          right: -50%;
          border-radius: 3px;
          animation: roadAnimation 1.4s linear infinite;
          border-left: 10px solid white;
        }
        .road::after {
          content: "";
          position: absolute;
          width: 10px;
          height: 100%;
          background-color: #282828;
          right: -65%;
          border-radius: 3px;
          animation: roadAnimation 1.4s linear infinite;
          border-left: 4px solid white;
        }

        .lampPost {
          position: absolute;
          bottom: 0;
          right: -90%;
          height: 90px;
          animation: roadAnimation 1.4s linear infinite;
        }

        @keyframes roadAnimation {
          0% {
            transform: translateX(0px);
          }
          100% {
            transform: translateX(-350px);
          }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen selection:bg-indigo-100 selection:text-indigo-700">

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <!-- From Uiverse.io by vinodjangid07 --> 
        <div class="loader">
          <div class="truckWrapper">
            <div class="truckBody">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 198 93" class="trucksvg">
                <path stroke-width="3" stroke="#282828" fill="#F83D3D" d="M135 22.5H177.264C178.295 22.5 179.22 23.133 179.594 24.0939L192.33 56.8443C192.442 57.1332 192.5 57.4404 192.5 57.7504V89C192.5 90.3807 191.381 91.5 190 91.5H135C133.619 91.5 132.5 90.3807 132.5 89V25C132.5 23.6193 133.619 22.5 135 22.5Z"></path>
                <path stroke-width="3" stroke="#282828" fill="#7D7C7C" d="M146 33.5H181.741C182.779 33.5 183.709 34.1415 184.078 35.112L190.538 52.112C191.16 53.748 189.951 55.5 188.201 55.5H146C144.619 55.5 143.5 54.3807 143.5 53V36C143.5 34.6193 144.619 33.5 146 33.5Z"></path>
                <path stroke-width="2" stroke="#282828" fill="#282828" d="M150 65C150 65.39 149.763 65.8656 149.127 66.2893C148.499 66.7083 147.573 67 146.5 67C145.427 67 144.501 66.7083 143.873 66.2893C143.237 65.8656 143 65.39 143 65C143 64.61 143.237 64.1344 143.873 63.7107C144.501 63.2917 145.427 63 146.5 63C147.573 63 148.499 63.2917 149.127 63.7107C149.763 64.1344 150 64.61 150 65Z"></path>
                <rect stroke-width="2" stroke="#282828" fill="#FFFCAB" rx="1" height="7" width="5" y="63" x="187"></rect>
                <rect stroke-width="2" stroke="#282828" fill="#282828" rx="1" height="11" width="4" y="81" x="193"></rect>
                <rect stroke-width="3" stroke="#282828" fill="#DFDFDF" rx="2.5" height="90" width="121" y="1.5" x="6.5"></rect>
                <rect stroke-width="2" stroke="#282828" fill="#DFDFDF" rx="2" height="4" width="6" y="84" x="1"></rect>
              </svg>
            </div>
            <div class="truckTires">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30" class="tiresvg">
                <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
              </svg>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30" class="tiresvg">
                <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
              </svg>
            </div>
            <div class="road"></div>
            <svg xml:space="preserve" viewBox="0 0 453.459 453.459" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" id="Capa_1" version="1.1" fill="#000000" class="lampPost">
              <path d="M252.882,0c-37.781,0-68.686,29.953-70.245,67.358h-6.917v8.954c-26.109,2.163-45.463,10.011-45.463,19.366h9.993
            c-1.65,5.146-2.507,10.54-2.507,16.017c0,28.956,23.558,52.514,52.514,52.514c28.956,0,52.514-23.558,52.514-52.514
            c0-5.478-0.856-10.872-2.506-16.017h9.992c0-9.354-19.352-17.204-45.463-19.366v-8.954h-6.149C200.189,38.779,223.924,16,252.882,16
            c29.952,0,54.32,24.368,54.32,54.32c0,28.774-11.078,37.009-25.105,47.437c-17.444,12.968-37.216,27.667-37.216,78.884v113.914
            h-0.797c-5.068,0-9.174,4.108-9.174,9.177c0,2.844,1.293,5.383,3.321,7.066c-3.432,27.933-26.851,95.744-8.226,115.459v11.202h45.75
            v-11.202c18.625-19.715-4.794-87.527-8.227-115.459c2.029-1.683,3.322-4.223,3.322-7.066c0-5.068-4.107-9.177-9.176-9.177h-0.795
            V196.641c0-43.174,14.942-54.283,30.762-66.043c14.793-10.997,31.559-23.461,31.559-60.277C323.202,31.545,291.656,0,252.882,0z
            M232.77,111.694c0,23.442-19.071,42.514-42.514,42.514c-23.442,0-42.514-19.072-42.514-42.514c0-5.531,1.078-10.957,3.141-16.017
            h78.747C231.693,100.736,232.77,106.162,232.77,111.694z"></path>
            </svg>
          </div>
        </div>
        <h3 class="text-slate-800 font-bold text-lg mt-2 tracking-wide" id="loadingText">Processing...</h3>
    </div>

    <!-- OVERLAYS -->
    <div id="toast-container" class="fixed top-0 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-full max-w-sm"></div>

    <!-- Password Modal -->
    <div id="passwordModal" class="fixed inset-0 z-[60] bg-slate-900/40 backdrop-blur-md hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[320px] p-8 transform scale-95 transition-all duration-300 border border-white/50" id="passwordModalContent">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600 shadow-sm">
                    <i class="fa-solid fa-lock text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800" id="modalTitle">Security Check</h3>
                <p class="text-xs text-slate-500 mt-1" id="modalDesc">Please enter access code</p>
            </div>
            <div class="relative mb-6">
                <input type="password" id="passwordInput" class="w-full text-center py-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-indigo-500 outline-none transition-all text-sm font-mono tracking-[0.5em]" placeholder="••••••" onkeypress="handleEnter(event)">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="window.closePasswordModal()" class="py-2.5 rounded-xl border border-slate-200 text-slate-500 text-xs font-bold hover:bg-slate-50">Cancel</button>
                <button onclick="window.submitPassword()" class="py-2.5 rounded-xl bg-indigo-600 text-white text-xs font-bold hover:bg-indigo-700 shadow-lg">Verify</button>
            </div>
        </div>
    </div>

    <!-- Delete Date Modal -->
    <div id="deleteModal" class="fixed inset-0 z-[60] bg-slate-900/40 backdrop-blur-md hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[340px] p-8 transform scale-95 transition-all duration-300 border border-white/50" id="deleteModalContent">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-red-600 shadow-sm">
                    <i class="fa-solid fa-calendar-xmark text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Hapus Data</h3>
                <p class="text-xs text-slate-500 mt-1">Pilih tanggal untuk menghapus data</p>
            </div>
            <div class="relative mb-4">
                <label class="input-label mb-2">Tanggal Diterima</label>
                <input type="date" id="deleteDateInput" class="w-full text-center py-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-red-500 outline-none transition-all text-sm font-bold text-slate-700">
            </div>
            <div class="relative mb-6">
                <label class="input-label mb-2">Destinasi (Opsional)</label>
                <select id="deleteDestInput" class="w-full text-center py-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-red-500 outline-none transition-all text-sm font-bold text-slate-700 cursor-pointer">
                    <option value="ALL">Semua Destinasi</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="window.closeDeleteModal()" class="py-2.5 rounded-xl border border-slate-200 text-slate-500 text-xs font-bold hover:bg-slate-50">Batal</button>
                <button onclick="window.confirmDelete()" class="py-2.5 rounded-xl bg-red-600 text-white text-xs font-bold hover:bg-red-700 shadow-lg">Hapus</button>
            </div>
        </div>
    </div>

    <!-- Preview Upload Modal -->
    <div id="previewModal" class="fixed inset-0 z-[60] bg-slate-900/40 backdrop-blur-md hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[360px] p-8 transform scale-95 transition-all duration-300 border border-white/50" id="previewModalContent">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600 shadow-sm">
                    <i class="fa-solid fa-magnifying-glass-chart text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Analisis Data</h3>
                <p class="text-xs text-slate-500 mt-1">Laporan pra-unggah (Pengecekan Duplikat)</p>
            </div>
            <div class="bg-slate-50 rounded-xl p-4 mb-6 border border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-xs font-bold text-slate-600">Data Baru (Akan Disimpan):</span>
                    <span class="text-sm font-black text-emerald-600" id="previewNewCount">0</span>
                </div>
                <div class="flex justify-between items-center border-t border-slate-200 pt-3">
                    <span class="text-xs font-bold text-slate-500">Data Duplikat (Diabaikan):</span>
                    <span class="text-sm font-black text-rose-500" id="previewDupCount">0</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="window.closePreviewModal()" class="py-2.5 rounded-xl border border-slate-200 text-slate-500 text-xs font-bold hover:bg-slate-50">Batal</button>
                <button onclick="window.confirmUpload()" class="py-2.5 rounded-xl bg-indigo-600 text-white text-xs font-bold hover:bg-indigo-700 shadow-lg">Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Success Upload Modal -->
    <div id="successModal" class="fixed inset-0 z-[60] bg-slate-900/40 backdrop-blur-md hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[320px] p-8 transform scale-95 transition-all duration-300 border border-white/50" id="successModalContent">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-emerald-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-emerald-600 shadow-sm">
                    <i class="fa-solid fa-check-double text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Update Berhasil!</h3>
                <p class="text-xs text-slate-500 mt-2 leading-relaxed">
                    <span id="successCount" class="font-bold text-emerald-600 text-base">0</span> data baru telah berhasil disimpan ke dalam database.
                </p>
            </div>
            <button onclick="window.closeSuccessModal()" class="w-full py-3 rounded-xl bg-slate-900 text-white text-xs font-bold hover:bg-slate-800 shadow-lg transition">Selesai</button>
        </div>
    </div>

    <!-- HEADER -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-white/20 shadow-sm h-[72px]">
        <div class="max-w-[1600px] mx-auto px-6 h-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                    <i class="fa-solid fa-layer-group text-lg"></i>
                </div>
                <div>
                    <h1 class="text-base font-extrabold text-slate-800 tracking-tight leading-none">Inbound<span class="text-indigo-600">Tower</span></h1>
                    <div class="flex items-center gap-1.5 mt-1">
                        <span id="connectionStatus" class="w-1.5 h-1.5 rounded-full bg-slate-300 animate-pulse"></span>
                        <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wider" id="statusText">Connecting...</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex flex-col items-end">
                    <span class="text-[11px] font-bold text-slate-700" id="currentDateDisplay">-</span>
                    <span class="text-[9px] font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full">HUB-KalSulamp</span>
                </div>
                <div class="h-8 w-[1px] bg-slate-200 hidden md:block"></div>
                
                <button onclick="window.openDeleteModal()" class="btn-danger flex items-center gap-2 group">
                    <i class="fa-solid fa-trash-can group-hover:rotate-12 transition-transform"></i>
                    <span>Hapus Data</span>
                </button>

                <button onclick="window.openPasswordModal('upload')" class="btn-gradient flex items-center gap-2 group">
                    <i class="fa-solid fa-database group-hover:rotate-12 transition-transform"></i>
                    <span>Update Data</span>
                </button>
                <input type="file" id="csvFile" accept=".csv" class="hidden">
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow w-full max-w-[1600px] mx-auto px-4 py-4">
        <!-- EMPTY STATE -->
        <div id="initialState" class="flex flex-col items-center justify-center min-h-[60vh] animate-fade-in-up">
            <div class="w-24 h-24 bg-white rounded-3xl flex items-center justify-center border-2 border-dashed border-indigo-200 shadow-xl shadow-indigo-100 mx-auto mb-6">
                <i class="fa-solid fa-satellite-dish text-3xl text-indigo-300 animate-pulse"></i>
            </div>
            <h2 class="text-lg font-bold text-slate-800">Connecting to Cloud...</h2>
            <p class="text-xs text-slate-500 mt-2 font-medium">Fetching inbound data from database.</p>
        </div>

        <!-- DASHBOARD CONTENT -->
        <div id="dashboardContent" class="hidden space-y-6">
            
            <!-- 1. FILTERS & CONTROLS (STICKY BOX) -->
            <div class="sticky-filter-wrapper">
                <div class="fresh-card p-3 sm:p-4">
                    <div class="grid grid-cols-12 md:flex md:flex-row md:flex-nowrap gap-3 items-end w-full">
                        
                        <!-- Search -->
                        <div class="col-span-6 md:w-36 lg:w-48 shrink-0 relative group">
                            <span class="input-label truncate">Pencarian Global</span>
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-[34px] text-slate-400 text-[10px] group-focus-within:text-indigo-500 transition-colors"></i>
                            <input type="text" id="globalSearch" placeholder="Cari data..." class="fresh-input w-full pl-8 bg-white text-[11px]" oninput="window.applyFilters()">
                        </div>

                        <!-- Date Range -->
                        <div class="col-span-6 md:w-auto shrink-0">
                            <span class="input-label truncate">Rentang Tanggal</span>
                            <div class="flex items-center bg-white rounded-xl border border-slate-200 p-1 shadow-sm h-[38px] justify-between">
                                <input type="date" id="filterStartDate" class="text-[10px] sm:text-[11px] font-semibold text-slate-600 px-0.5 outline-none w-[45%] md:w-24 bg-transparent" onchange="window.applyFilters()">
                                <span class="text-slate-300 text-[9px] mx-0.5 font-bold">SD</span>
                                <input type="date" id="filterEndDate" class="text-[10px] sm:text-[11px] font-semibold text-slate-600 px-0.5 outline-none w-[45%] md:w-24 bg-transparent" onchange="window.applyFilters()">
                            </div>
                        </div>

                        <!-- Origin -->
                        <div class="col-span-3 md:w-24 lg:w-28 shrink-0 relative">
                            <span class="input-label truncate">Origin</span>
                            <button onclick="window.toggleMulti('originMenu')" class="fresh-input w-full text-left flex justify-between items-center bg-white h-[38px] relative z-10 group px-2 sm:px-3">
                                <span id="originLabel" class="truncate text-[10px] sm:text-[11px] text-slate-600">Semua</span>
                                <i class="fa-solid fa-chevron-down text-[9px] text-slate-400 group-hover:text-indigo-500"></i>
                            </button>
                            <div id="originMenu" class="hidden absolute top-full left-0 w-48 bg-white border border-slate-200 shadow-xl rounded-xl mt-1 z-[60] max-h-60 overflow-y-auto p-2 flex flex-col gap-1"></div>
                        </div>

                        <!-- Destinasi -->
                        <div class="col-span-3 md:w-24 lg:w-28 shrink-0 relative">
                            <span class="input-label truncate">Destinasi</span>
                            <button onclick="window.toggleMulti('destMenu')" class="fresh-input w-full text-left flex justify-between items-center bg-white h-[38px] relative z-10 group px-2 sm:px-3">
                                <span id="destLabel" class="truncate text-[10px] sm:text-[11px] text-slate-600">Semua</span>
                                <i class="fa-solid fa-chevron-down text-[9px] text-slate-400 group-hover:text-indigo-500"></i>
                            </button>
                            <div id="destMenu" class="hidden absolute top-full right-0 left-auto md:left-0 md:right-auto w-48 bg-white border border-slate-200 shadow-xl rounded-xl mt-1 z-[60] max-h-60 overflow-y-auto p-2 flex flex-col gap-1"></div>
                        </div>

                        <!-- Layanan -->
                        <div class="col-span-4 md:flex-1 min-w-[80px] overflow-hidden shrink-0">
                            <span class="input-label truncate">Layanan</span>
                            <div class="flex items-center gap-1 overflow-x-auto no-scrollbar pb-1 h-[38px]" id="serviceToggleContainer"></div>
                        </div>

                        <!-- Reset -->
                        <div class="col-span-2 md:w-[38px] shrink-0">
                            <span class="input-label hidden md:block">&nbsp;</span>
                            <button onclick="window.resetFilters()" class="w-full md:w-[38px] h-[38px] flex items-center justify-center bg-white border border-slate-200 rounded-xl hover:bg-slate-50 hover:text-indigo-600 text-slate-400 transition-all shadow-sm" title="Reset Filters">
                                <i class="fa-solid fa-arrows-rotate text-xs"></i>
                            </button>
                        </div>
                        
                    </div>
                </div>
            </div>

            <!-- 2. KPI -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-5 pt-2">
                <!-- Tonnage -->
                <div class="fresh-card p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500"><i class="fa-solid fa-weight-hanging text-6xl text-indigo-600"></i></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Tonnage</p>
                            <div class="flex items-baseline gap-2 mt-1"><h3 class="text-3xl font-extrabold text-slate-800 tracking-tight" id="kpiWeight">0</h3><span class="text-xs font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-md">Kg</span></div>
                            <div class="mt-3 flex items-center gap-2"><span id="kpiWeightDiff" class="text-[10px] font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-500 transition-colors">0%</span><span class="text-[10px] text-slate-400 font-medium">vs periode sebelumnya</span></div>
                        </div>
                    </div>
                </div>
                <!-- Parcel -->
                <div class="fresh-card p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500"><i class="fa-solid fa-box-open text-6xl text-emerald-600"></i></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Parcel</p>
                            <div class="flex items-baseline gap-2 mt-1"><h3 class="text-3xl font-extrabold text-slate-800 tracking-tight" id="kpiPcs">0</h3><span class="text-xs font-bold text-emerald-500 bg-emerald-50 px-2 py-0.5 rounded-md">AWB</span></div>
                            <div class="mt-3 flex items-center gap-2"><span id="kpiPcsDiff" class="text-[10px] font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-500 transition-colors">0%</span><span class="text-[10px] text-slate-400 font-medium">vs periode sebelumnya</span></div>
                        </div>
                    </div>
                </div>
                <!-- Bagseals -->
                <div class="fresh-card p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500"><i class="fa-solid fa-tags text-6xl text-amber-600"></i></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Bagseals</p>
                            <div class="flex items-baseline gap-2 mt-1"><h3 class="text-3xl font-extrabold text-slate-800 tracking-tight" id="kpiMB">0</h3><span class="text-xs font-bold text-amber-500 bg-amber-50 px-2 py-0.5 rounded-md">Seal</span></div>
                            <div class="mt-3 flex items-center gap-2"><span id="kpiMBDiff" class="text-[10px] font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-500 transition-colors">0%</span><span class="text-[10px] text-slate-400 font-medium">vs periode sebelumnya</span></div>
                        </div>
                    </div>
                </div>
                <!-- Average SLA (Gabungan Tercepat & Terlama) -->
                <div class="fresh-card p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500"><i class="fa-solid fa-bolt text-6xl text-emerald-600"></i></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div class="w-full">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Average SLA</p>
                            <div class="flex items-baseline gap-2 mt-1">
                                <h3 class="text-3xl font-extrabold text-slate-800 tracking-tight" id="kpiAvgSLA">0</h3>
                                <span class="text-xs font-bold text-emerald-500 bg-emerald-50 px-2 py-0.5 rounded-md">Hari</span>
                            </div>
                            <div class="mt-3 flex items-center justify-between w-full border-t border-slate-100 pt-3">
                                <div class="flex flex-col">
                                    <span class="text-[9px] text-slate-400 font-bold uppercase">Tercepat</span>
                                    <span class="text-xs font-black text-emerald-600"><span id="kpiMinSLA">0</span> Hari</span>
                                </div>
                                <div class="h-6 w-[1px] bg-slate-200"></div>
                                <div class="flex flex-col items-end">
                                    <span class="text-[9px] text-slate-400 font-bold uppercase">Terlama</span>
                                    <span class="text-xs font-black text-rose-600"><span id="kpiMaxSLA">0</span> Hari</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. VOLUME CHART -->
            <div class="fresh-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600"><i class="fa-solid fa-chart-area"></i></div><h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide">Volume Trend (Total Pcs)</h3></div>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button id="btnDaily" onclick="window.setMainChartMode('daily')" class="px-6 py-2 rounded-lg text-[10px] font-bold transition-all bg-slate-900 text-white shadow-md">Daily</button>
                        <button id="btnMonthly" onclick="window.setMainChartMode('monthly')" class="px-6 py-2 rounded-lg text-[10px] font-bold transition-all bg-white text-slate-600 hover:bg-slate-50">Monthly</button>
                    </div>
                </div>
                <div class="h-72 w-full relative"><canvas id="mainChart"></canvas></div>
            </div>

            <!-- 3.5 TIME TREND & SERVICE SHARE -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Time Trend (75%) -->
                <div class="lg:col-span-3 fresh-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-600"><i class="fa-regular fa-clock"></i></div>
                            <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide">Tren Jam Inbound (Qty Pcs)</h3>
                        </div>
                    </div>
                    <div class="h-60 w-full relative"><canvas id="timeChart"></canvas></div>
                </div>

                <!-- Service Share (25%) -->
                <div class="lg:col-span-1 fresh-card p-5 flex flex-col">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-slate-300"></i> Service Share
                    </h4>
                    <div class="h-[200px] flex items-center justify-center relative mb-4">
                        <canvas id="chartService"></canvas>
                    </div>
                    <div class="overflow-x-auto mt-2">
                        <table class="w-full text-[10px] text-slate-600" id="serviceTable"></table>
                    </div>
                </div>
            </div>

            <!-- 4. DISTRIBUTIONS (REMAINING 3) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="fresh-card p-5 flex flex-col">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><i class="fa-solid fa-building text-slate-300"></i> Top Vendor</h4>
                    <div class="flex-grow relative h-[300px] w-full"><canvas id="chartVendor"></canvas></div>
                </div>
                <div class="fresh-card p-5 flex flex-col">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><i class="fa-solid fa-plane-departure text-slate-300"></i> Origin Dist.</h4>
                    <div class="flex-grow relative h-[300px] w-full"><canvas id="chartOrigin"></canvas></div>
                </div>
                <div class="fresh-card p-5 flex flex-col">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><i class="fa-solid fa-location-dot text-slate-300"></i> Destinasi Dist.</h4>
                    <div class="flex-grow relative h-[300px] w-full"><canvas id="chartDestinasi"></canvas></div>
                </div>
            </div>
            
            <!-- 4b. REJECTED TABLE -->
            <div class="fresh-card overflow-hidden border-l-4 border-red-500">
                <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-2 bg-red-50/20">
                    <div class="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center text-red-600"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <h3 class="text-[11px] font-bold text-red-600 uppercase">Exception Monitoring: Tolakan Bandara</h3>
                </div>
                <div class="overflow-x-auto custom-scrollbar max-h-80">
                    <table class="fresh-table w-full" id="rejectedTable"></table>
                </div>
            </div>

            <!-- 5a. SLA BREAKDOWN -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                <div class="fresh-card overflow-hidden">
                    <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2"><span class="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span><h3 class="text-[11px] font-bold text-slate-600 uppercase">SLA by Origin</h3></div>
                    <div class="overflow-x-auto custom-scrollbar max-h-64"><table class="fresh-table w-full" id="slaOriginTable"></table></div>
                </div>
                <div class="fresh-card overflow-hidden">
                    <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2"><span class="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span><h3 class="text-[11px] font-bold text-slate-600 uppercase">SLA by Destination</h3></div>
                    <div class="overflow-x-auto custom-scrollbar max-h-64"><table class="fresh-table w-full" id="slaDestTable"></table></div>
                </div>
            </div>

            <!-- 5. MATRIX SUMMARY -->
            <div class="fresh-card overflow-hidden mb-5">
                <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-calendar-week text-slate-300"></i>
                        <h3 class="text-[11px] font-bold text-slate-600 uppercase">Daily Matrix Volume (Total Pcs)</h3>
                    </div>
                    <!-- Pagination Controls -->
                     <div class="flex items-center space-x-1 bg-slate-50 p-1 rounded-lg border border-slate-100" id="matrixPaginationContainer">
                        <button onclick="window.changeMatrixPage(-1)" class="w-7 h-7 flex items-center justify-center rounded-md bg-white text-slate-400 hover:text-indigo-600 hover:shadow-sm transition"><i class="fa-solid fa-chevron-left text-[10px]"></i></button>
                        <span id="matrixPageIndicator" class="px-3 text-[10px] font-mono font-bold text-slate-500">1</span>
                        <button onclick="window.changeMatrixPage(1)" class="w-7 h-7 flex items-center justify-center rounded-md bg-white text-slate-400 hover:text-indigo-600 hover:shadow-sm transition"><i class="fa-solid fa-chevron-right text-[10px]"></i></button>
                    </div>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="fresh-table w-full" id="matrixTable"></table>
                </div>
            </div>

            <!-- 6. DETAIL DATA TABLE (SPLIT LAYOUT) -->
            <div class="grid grid-cols-12 gap-6 mb-10">
                <!-- Left Column: Bagseals & Notes -->
                <div class="col-span-12 lg:col-span-10 fresh-card overflow-hidden flex flex-col">
                    <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                        <h3 class="text-[11px] font-bold text-slate-700 uppercase flex items-center gap-2">
                            <span class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fa-solid fa-list-check"></i></span>
                            Manifest Summary
                        </h3>
                        <div class="flex items-center gap-3">
                            <button onclick="window.downloadManifestCSV()" class="text-[10px] font-bold text-emerald-600 hover:text-emerald-800 bg-emerald-50 px-3 py-1.5 rounded-lg border border-emerald-100 transition shadow-sm flex items-center gap-1.5">
                                <i class="fa-solid fa-file-csv"></i> Download Detail CSV
                            </button>
                        </div>
                    </div>
                    <!-- Max-h & overflow-auto agar tabel bisa di-scroll secara internal dan header-nya sticky -->
                    <div class="overflow-auto custom-scrollbar max-h-[800px]">
                        <table class="fresh-table w-full relative">
                            <!-- class sticky top-0 z-30 shadow-sm -->
                            <thead class="sticky top-0 z-30 shadow-sm">
                                <tr>
                                    <th class="text-center group-col w-24">Tgl Terima</th>
                                    <th class="text-left group-col w-16">Jam</th>
                                    <th class="text-center bg-indigo-50 text-indigo-700 w-24 border-r border-slate-300">Destinasi</th>
                                    <th class="text-left group-col w-20">Tgl PA</th>
                                    <th class="text-left group-col w-16">Batch</th>
                                    <th class="text-left group-col">Origin</th>
                                    <th class="text-left">SMU</th>
                                    <th class="text-left">Flight</th>
                                    <th class="text-left w-20">Tgl Flight</th>
                                    <th class="text-center w-16">SLA (H)</th>
                                    <th class="text-center w-16">Total MB</th>
                                    <th class="text-right w-16">Total Pcs</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-slate-50 text-[10px] text-slate-400 text-center border-t border-slate-100 font-mono font-medium">
                        Total <span id="totalCount" class="text-slate-600 font-bold">0</span> records
                    </div>
                </div>

                <!-- Right Column: Bagseals List -->
                <div class="col-span-12 lg:col-span-2 fresh-card overflow-hidden flex flex-col max-h-[800px]">
                    <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                        <h3 class="text-[11px] font-bold text-slate-700 uppercase flex items-center gap-2">
                            <span class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fa-solid fa-tags"></i></span>
                            Bagshield
                        </h3>
                        <button onclick="window.copyBagseals()" class="text-[10px] font-bold text-indigo-600 hover:text-indigo-800 bg-indigo-50 px-2 py-1 rounded border border-indigo-100 transition shadow-sm">
                            <i class="fa-regular fa-copy mr-1"></i> Salin
                        </button>
                    </div>
                    <div class="overflow-y-auto custom-scrollbar flex-grow p-0">
                        <table class="w-full text-xs text-left" id="bagsealTable">
                            <!-- JS Generated -->
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- STANDARD SCRIPT (Logic & UI) -->
    <script>
        Chart.register(ChartDataLabels);

        // --- GLOBAL VARIABLES ---
        window.rawData = [];
        window.filteredData = [];
        window.aggregatedData = [];
        window.rejectedData = []; 
        window.chartInstances = {};
        window.currentChartMode = 'daily';
        
        // Matrix Pagination
        window.matrixPage = 1;
        window.matrixRowsPerPage = 7;

        window.selectedService = 'ALL';
        window.currentAction = ''; 

        document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });

        // --- HELPERS ---
        window.parseNum = (str) => {
            if (typeof str === 'number') return str;
            if (!str) return 0;
            let s = str.toString().trim();
            let f = parseFloat(s.replace(',', '.'));
            return isNaN(f) ? 0 : f;
        };

        window.toLocalISOString = (d) => {
            if (d instanceof Date && !isNaN(d)) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const dy = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${dy}`;
            }
            return '';
        };
        
        window.parseDate = (dateStr) => {
            if (!dateStr) return null;
            if (dateStr.includes('/')) { 
                const p = dateStr.split('/'); 
                if (p.length === 3) return new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0])); 
            }
            const m = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11};
            const p = dateStr.trim().split(' ');
            if (p.length >= 3) { let y = parseInt(p[2]); if (y < 100) y += 2000; return new Date(y, m[p[1]], parseInt(p[0])); }
            return null;
        };
        
        window.formatDate = (d) => {
            if (d instanceof Date && !isNaN(d)) {
                return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
            }
            return '-';
        };
        
        window.formatInputDate = (d) => window.toLocalISOString(d);
        window.formatNumber = (num) => num ? num.toLocaleString('id-ID') : '0';

        // NEW HELPER: Get Monday of a given date (for Weekly Matrix)
        window.getMondayTime = (d) => {
            if (!(d instanceof Date) || isNaN(d)) return 0;
            const dt = new Date(d);
            const day = dt.getDay() || 7; // Make Sunday (0) = 7
            dt.setHours(0,0,0,0);
            dt.setDate(dt.getDate() - day + 1);
            return dt.getTime();
        };

        // --- TOAST ---
        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if(!container) return;
            const toast = document.createElement('div');
            let icon = '';
            if(type === 'success') icon = '<i class="fa-solid fa-circle-check text-emerald-500 text-lg"></i>';
            else if(type === 'error') icon = '<i class="fa-solid fa-circle-xmark text-rose-500 text-lg"></i>';
            else icon = '<i class="fa-solid fa-circle-info text-indigo-500 text-lg"></i>';

            toast.className = `toast-animate pointer-events-auto flex items-center gap-3 px-5 py-3 bg-white rounded-2xl shadow-hover border border-slate-100 min-w-[240px] justify-center`;
            toast.innerHTML = `${icon}<span class="text-xs font-bold text-slate-600">${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translate(-50%, -20px)'; setTimeout(() => toast.remove(), 300); }, 3000);
        };

        // --- MODAL CONTROLS ---
        window.openPasswordModal = function(action) {
            window.currentAction = action;
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = action === 'delete' ? 'Konfirmasi Hapus' : 'Admin Access';
            document.getElementById('modalDesc').textContent = action === 'delete' ? 'Masukkan kode untuk konfirmasi' : 'Please enter access code';
            setTimeout(() => {
                document.getElementById('passwordModal').classList.remove('opacity-0');
                document.getElementById('passwordModalContent').classList.remove('scale-95');
                document.getElementById('passwordModalContent').classList.add('scale-100');
            }, 10);
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        };

        window.closePasswordModal = function() {
            document.getElementById('passwordModal').classList.add('opacity-0');
            document.getElementById('passwordModalContent').classList.remove('scale-100');
            document.getElementById('passwordModalContent').classList.add('scale-95');
            setTimeout(() => document.getElementById('passwordModal').classList.add('hidden'), 300);
        };
        
        window.openDeleteModal = function() {
            document.getElementById('deleteModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('deleteModal').classList.remove('opacity-0');
                document.getElementById('deleteModalContent').classList.remove('scale-95');
                document.getElementById('deleteModalContent').classList.add('scale-100');
            }, 10);
        };
        
        window.closeDeleteModal = function() {
            document.getElementById('deleteModal').classList.add('opacity-0');
            document.getElementById('deleteModalContent').classList.remove('scale-100');
            document.getElementById('deleteModalContent').classList.add('scale-95');
            setTimeout(() => document.getElementById('deleteModal').classList.add('hidden'), 300);
        };

        window.openPreviewModal = function(newCount, dupCount) {
            document.getElementById('previewModal').classList.remove('hidden');
            document.getElementById('previewNewCount').textContent = window.formatNumber(newCount);
            document.getElementById('previewDupCount').textContent = window.formatNumber(dupCount);
            setTimeout(() => {
                document.getElementById('previewModal').classList.remove('opacity-0');
                document.getElementById('previewModalContent').classList.remove('scale-95');
                document.getElementById('previewModalContent').classList.add('scale-100');
            }, 10);
        };

        window.closePreviewModal = function() {
            document.getElementById('previewModal').classList.add('opacity-0');
            document.getElementById('previewModalContent').classList.remove('scale-100');
            document.getElementById('previewModalContent').classList.add('scale-95');
            setTimeout(() => document.getElementById('previewModal').classList.add('hidden'), 300);
        };

        window.openSuccessModal = function(count) {
            document.getElementById('successModal').classList.remove('hidden');
            document.getElementById('successCount').textContent = window.formatNumber(count);
            setTimeout(() => {
                document.getElementById('successModal').classList.remove('opacity-0');
                document.getElementById('successModalContent').classList.remove('scale-95');
                document.getElementById('successModalContent').classList.add('scale-100');
            }, 10);
        };

        window.closeSuccessModal = function() {
            document.getElementById('successModal').classList.add('opacity-0');
            document.getElementById('successModalContent').classList.remove('scale-100');
            document.getElementById('successModalContent').classList.add('scale-95');
            setTimeout(() => {
                document.getElementById('successModal').classList.add('hidden');
            }, 300);
        };
        
        window.confirmDelete = function() {
             const date = document.getElementById('deleteDateInput').value;
             if(!date) return window.showToast("Pilih tanggal dulu!", "error");
             window.closeDeleteModal();
             window.openPasswordModal('delete');
        };

        window.handleEnter = function(e) { if (e.key === 'Enter') window.submitPassword(); };

        window.submitPassword = function() {
            const pwd = document.getElementById('passwordInput').value;
            if (pwd === "TAB123") {
                window.closePasswordModal();
                if(window.currentAction === 'upload') {
                    window.showToast("Authorized", "success");
                    setTimeout(() => document.getElementById('csvFile').click(), 500);
                } else if(window.currentAction === 'delete') {
                    const date = document.getElementById('deleteDateInput').value;
                    const dest = document.getElementById('deleteDestInput').value;
                    if(window.deleteDataForDate) window.deleteDataForDate(date, dest);
                    else window.showToast("Service Offline", "error");
                }
            } else {
                window.showToast("Invalid Passcode", "error");
                document.getElementById('passwordInput').value = '';
            }
        };

        window.showLoading = function(show, text) {
            const el = document.getElementById('loadingOverlay');
            if(show) {
                el.classList.remove('hidden');
                document.getElementById('loadingText').textContent = text;
            } else {
                el.classList.add('hidden');
            }
        };

        // --- PROCESSING (Global wrapper) ---
        window.processRawDataWrapper = function(data) {
            const validData = [];
            const rejectedData = [];

            data.forEach(row => {
                const tglTerimaStr = row['Tanggal DIterima'] || '';
                
                let vendor = (row['VENDOR'] || 'N/A').toUpperCase();
                let origin = (row['Origin'] || 'N/A').toUpperCase();
                let dest = (row['Destinasi'] || 'Unknown').toUpperCase();
                let batch = (row['BATCH'] || 'N/A').toString().toUpperCase();
                let service = (row['SERVICE'] || 'N/A').toUpperCase();
                if (service === 'REG') service = 'REGULER';
                
                const rawFlight = row['FLIGHT'] || '-';
                let cleanFlight = rawFlight.toUpperCase();
                if (service === 'REGULER') cleanFlight = rawFlight.replace(/[\s-]/g, '').toUpperCase();
                
                if (tglTerimaStr.toLowerCase().includes('tolakan')) {
                    rejectedData.push({
                        _tglPA: window.parseDate(row['Tanggal']),
                        _origin: origin,
                        _vendor: vendor,
                        _dest: dest,
                        _smu: row['SMU'] || '-',
                        _flight: cleanFlight,
                        _batch: batch,
                        _pcs: window.parseNum(row['Kuantitas Paket (Awb)']),
                        _weight: window.parseNum(row['Berat Total (kg)']),
                        _note: row['Note'] || row['CATATAN'] || tglTerimaStr,
                        _tglFlight: row['TANGGAL FLIGHT'],
                        _etd: row['ETD'],
                        _mb: row['No Bagseals'],
                        _service: service,
                        _firestoreId: row._firestoreId // Capture ID even for rejected
                    });
                    return; 
                }

                const tglTerima = window.parseDate(tglTerimaStr);
                const tglOrigin = window.parseDate(row['Tanggal']); 
                
                if (tglTerima) {
                    let sla = 0;
                    if (tglOrigin) {
                        const diff = tglTerima - tglOrigin;
                        sla = Math.ceil(diff / (1000 * 60 * 60 * 24));
                    }

                    validData.push({
                        ...row,
                        _date: tglTerima,
                        _dateOrigin: tglOrigin,
                        _weight: window.parseNum(row['Berat Total (kg)']),
                        _pcs: window.parseNum(row['Kuantitas Paket (Awb)']), 
                        _vendor: vendor,
                        _origin: origin,
                        _dest: dest,
                        _service: service,
                        _batch: batch,
                        _jam: row['JAM'] || '-',
                        _smu: row['SMU'] || '-',
                        _flight: cleanFlight,
                        _tglFlight: row['TANGGAL FLIGHT'] || '-',
                        _mb: row['No Bagseals'] || '-',
                        _note: row['Note'] || row['CATATAN'] || '',
                        _sla: sla,
                        _firestoreId: row._firestoreId // Capture ID
                    });
                }
            });

            window.rawData = validData;
            window.rejectedData = rejectedData;

            window.populateFilters();
            window.renderRejectedTable();
            
            const dates = window.rawData.map(d => d._date).sort((a,b) => a-b);
            if (dates.length > 0) {
                document.getElementById('filterStartDate').value = window.formatInputDate(dates[0]);
                document.getElementById('filterEndDate').value = window.formatInputDate(dates[dates.length-1]);
            }

            window.applyFilters();
        };

        // --- NEW REJECTED TABLE RENDERER ---
        window.renderRejectedTable = function() {
            const table = document.getElementById('rejectedTable');
            if (window.rejectedData.length === 0) {
                table.innerHTML = `<tr><td class="p-4 text-center text-slate-400 italic">Tidak ada data tolakan</td></tr>`;
                return;
            }
            let html = `<thead class="bg-red-50"><tr>
                <th class="text-left text-red-600">Tgl PA</th>
                <th class="text-center text-red-600">Batch</th>
                <th class="text-left text-red-600">Origin</th>
                <th class="text-left text-red-600">Vendor</th>
                <th class="text-left text-red-600">Service</th>
                <th class="text-left text-red-600">Destinasi</th>
                <th class="text-left text-red-600">SMU</th>
                <th class="text-left text-red-600">Flight</th>
                <th class="text-left text-red-600">Tgl Flight</th>
                <th class="text-left text-red-600">ETD</th>
                <th class="text-center text-red-600">No Bagseals</th>
                <th class="text-right text-red-600">Berat (Kg)</th>
                <th class="text-right text-red-600">Pcs</th>
                <th class="text-left text-red-600">Note</th>
            </tr></thead><tbody>`;

            window.rejectedData.forEach(d => {
                const datePa = d._tglPA ? window.formatDate(d._tglPA) : '-';
                html += `<tr class="hover:bg-red-50/30">
                    <td class="font-medium text-slate-600">${datePa}</td>
                    <td class="text-center">${d._batch}</td>
                    <td>${d._origin}</td>
                    <td>${d._vendor}</td>
                    <td>${d._service}</td>
                    <td class="font-bold text-slate-700">${d._dest}</td>
                    <td class="font-mono text-xs">${d._smu}</td>
                    <td>${d._flight}</td>
                    <td>${d._tglFlight}</td>
                    <td>${d._etd}</td>
                    <td class="text-center font-mono text-xs">${d._mb}</td>
                    <td class="text-right">${window.formatNumber(d._weight)}</td>
                    <td class="text-right font-bold">${window.formatNumber(d._pcs)}</td>
                    <td class="text-xs text-red-500 italic">${d._note}</td>
                </tr>`;
            });
            html += '</tbody>';
            table.innerHTML = html;
        };

        // --- FILTERS ---
        window.populateFilters = function() {
            const populateMulti = (menuId, labelId, field) => {
                const menu = document.getElementById(menuId);
                const opts = [...new Set(window.rawData.map(d => d[field]))].sort();
                
                let html = `
                    <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-indigo-50 rounded cursor-pointer transition-colors border-b border-slate-100 mb-1">
                        <input type="checkbox" value="ALL" class="accent-indigo-600 w-3.5 h-3.5" onchange="window.handleMultiChange('${menuId}', '${labelId}', this)" checked>
                        <span class="text-xs font-bold text-slate-700">Pilih Semua</span>
                    </label>
                `;
                
                opts.forEach(o => {
                    html += `
                    <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-slate-50 rounded cursor-pointer transition-colors">
                        <input type="checkbox" value="${o}" class="accent-indigo-600 w-3.5 h-3.5 item-checkbox" onchange="window.handleMultiChange('${menuId}', '${labelId}', this)" checked>
                        <span class="text-xs text-slate-600">${o}</span>
                    </label>`;
                });
                menu.innerHTML = html;
                window.updateMultiLabel(menuId, labelId);
            };

            populateMulti('originMenu', 'originLabel', '_origin');
            populateMulti('destMenu', 'destLabel', '_dest');

            // Populate delete destinasi dropdown
            const deleteDestSelect = document.getElementById('deleteDestInput');
            if (deleteDestSelect) {
                const currentVal = deleteDestSelect.value;
                const dests = [...new Set(window.rawData.map(d => d._dest))].sort();
                deleteDestSelect.innerHTML = '<option value="ALL">Semua Destinasi</option>' + dests.map(d => `<option value="${d}">${d}</option>`).join('');
                if (dests.includes(currentVal)) deleteDestSelect.value = currentVal;
            }

            const services = [...new Set(window.rawData.map(d => d._service))].sort();
            const container = document.getElementById('serviceToggleContainer');
            container.innerHTML = '';
            container.appendChild(window.createToggleBtn('ALL', 'ALL'));
            services.forEach(s => container.appendChild(window.createToggleBtn(s, s)));
            window.updateToggleVisuals();
        };

        window.toggleMulti = (id) => {
            const el = document.getElementById(id);
            ['originMenu', 'destMenu'].forEach(m => {
                if(m !== id) document.getElementById(m).classList.add('hidden');
            });
            el.classList.toggle('hidden');
        };

        window.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                document.getElementById('originMenu').classList.add('hidden');
                document.getElementById('destMenu').classList.add('hidden');
            }
        });

        window.handleMultiChange = (menuId, labelId, checkbox) => {
            const menu = document.getElementById(menuId);
            const allChk = menu.querySelector('input[value="ALL"]');
            const items = menu.querySelectorAll('input.item-checkbox');

            if (checkbox.value === 'ALL') {
                items.forEach(i => i.checked = checkbox.checked);
            } else {
                const allChecked = [...items].every(i => i.checked);
                allChk.checked = allChecked;
                if (!checkbox.checked) allChk.checked = false;
            }
            window.updateMultiLabel(menuId, labelId);
            window.applyFilters();
        };

        window.updateMultiLabel = (menuId, labelId) => {
            const menu = document.getElementById(menuId);
            const items = menu.querySelectorAll('input.item-checkbox');
            const checked = [...items].filter(i => i.checked);
            const label = document.getElementById(labelId);
            
            if (checked.length === 0) {
                label.textContent = "Pilih...";
                label.classList.add("text-slate-400");
            } else if (checked.length === items.length) {
                label.textContent = "Semua";
                label.classList.remove("text-slate-400", "font-bold", "text-indigo-600");
            } else {
                label.textContent = `${checked.length} Terpilih`;
                label.classList.add("font-bold", "text-indigo-600");
                label.classList.remove("text-slate-400");
            }
        };

        window.getSelectedValues = (menuId) => {
            const menu = document.getElementById(menuId);
            const allChk = menu.querySelector('input[value="ALL"]');
            if (allChk && allChk.checked) return ['ALL'];
            
            return [...menu.querySelectorAll('input.item-checkbox:checked')].map(i => i.value);
        };

        window.createToggleBtn = function(l, v) {
            const btn = document.createElement('button');
            btn.textContent = l; btn.dataset.value = v;
            btn.className = "pill-toggle mr-1 mb-1";
            btn.onclick = () => { window.selectedService = v; window.updateToggleVisuals(); window.applyFilters(); };
            return btn;
        };

        window.updateToggleVisuals = function() {
            document.querySelectorAll('#serviceToggleContainer button').forEach(b => {
                if (b.dataset.value === window.selectedService) b.className = "pill-toggle mr-1 mb-1 pill-active";
                else b.className = "pill-toggle mr-1 mb-1 pill-inactive";
            });
        };

        window.resetFilters = function() {
            ['originMenu', 'destMenu'].forEach(id => {
                const inputs = document.querySelectorAll(`#${id} input`);
                inputs.forEach(i => i.checked = true);
                const labelId = id === 'originMenu' ? 'originLabel' : 'destLabel';
                window.updateMultiLabel(id, labelId);
            });
            
            document.getElementById('globalSearch').value = '';
            window.selectedService = 'ALL';
            window.updateToggleVisuals();
            const dates = window.rawData.map(d => d._date).sort((a,b) => a-b);
            if(dates.length) {
                document.getElementById('filterStartDate').value = window.formatInputDate(dates[0]);
                document.getElementById('filterEndDate').value = window.formatInputDate(dates[dates.length-1]);
            }
            window.applyFilters();
            window.showToast("Reset Complete", "info");
        };

        window.applyFilters = function() {
            const startVal = document.getElementById('filterStartDate').value;
            const endVal = document.getElementById('filterEndDate').value;

            let sDate = null, eDate = null;
            if(startVal) {
                const p = startVal.split('-');
                sDate = new Date(p[0], p[1]-1, p[2]); 
            }
            if(endVal) {
                const p = endVal.split('-');
                eDate = new Date(p[0], p[1]-1, p[2]); 
                eDate.setHours(23,59,59,999); 
            }

            const fOrg = window.getSelectedValues('originMenu');
            const fDst = window.getSelectedValues('destMenu');
            const search = document.getElementById('globalSearch').value.toUpperCase();

            window.filteredData = window.rawData.filter(d => {
                if(!d._date) return false;
                
                const dateOk = (!sDate || d._date >= sDate) && (!eDate || d._date <= eDate);
                const orgOk = fOrg.includes('ALL') || fOrg.includes(d._origin);
                const dstOk = fDst.includes('ALL') || fDst.includes(d._dest);
                const svcOk = window.selectedService === 'ALL' || d._service === window.selectedService;
                
                let searchOk = true;
                if(search) {
                    const haystack = [
                        d._smu, d._flight, d._vendor, d._origin, d._dest,
                        d._batch, d._mb, d._note, d._service
                    ].join(' ').toUpperCase();
                    searchOk = haystack.includes(search);
                }
                
                return dateOk && orgOk && dstOk && svcOk && searchOk;
            });

            window.matrixPage = 1; 
            window.updateDashboard();
        };

        // --- DASHBOARD UPDATER ---
        window.updateDashboard = function() {
            const fd = window.filteredData;
            const w = fd.reduce((a,b) => a+b._weight, 0);
            const p = fd.reduce((a,b) => a+b._pcs, 0); 
            const m = fd.length;
            
            let avgSLA = 0;
            let minSLA = 0;
            let maxSLA = 0;
            if(fd.length > 0) {
                const slas = fd.map(d => d._sla || 0);
                minSLA = Math.min(...slas);
                maxSLA = Math.max(...slas);
                const totalSla = slas.reduce((acc, val) => acc + val, 0);
                avgSLA = totalSla / fd.length;
            }
            
            document.getElementById('kpiWeight').innerText = window.formatNumber(w);
            document.getElementById('kpiMB').innerText = window.formatNumber(m);
            document.getElementById('kpiPcs').innerText = window.formatNumber(p);
            
            document.getElementById('kpiAvgSLA').innerText = avgSLA.toFixed(1).replace('.', ',');
            document.getElementById('kpiMinSLA').innerText = window.formatNumber(minSLA);
            document.getElementById('kpiMaxSLA').innerText = window.formatNumber(maxSLA);

            const startStr = document.getElementById('filterStartDate').value;
            const endStr = document.getElementById('filterEndDate').value;
            let prevWeight = 0, prevPcs = 0, prevMB = 0;

            if(startStr && endStr) {
                const sDate = new Date(startStr.split('-')[0], startStr.split('-')[1]-1, startStr.split('-')[2]);
                const eDate = new Date(endStr.split('-')[0], endStr.split('-')[1]-1, endStr.split('-')[2]);
                const oneDay = 24*60*60*1000;
                const diffDays = Math.round(Math.abs((eDate - sDate) / oneDay)) + 1;
                const prevEndDate = new Date(sDate);
                prevEndDate.setDate(prevEndDate.getDate() - 1);
                prevEndDate.setHours(23,59,59,999);
                const prevStartDate = new Date(prevEndDate);
                prevStartDate.setDate(prevStartDate.getDate() - diffDays + 1); 
                prevStartDate.setHours(0,0,0,0);
                
                const fOrg = window.getSelectedValues('originMenu');
                const fDst = window.getSelectedValues('destMenu');

                const prevData = window.rawData.filter(d => {
                     const dateOk = d._date >= prevStartDate && d._date <= prevEndDate;
                     const orgOk = fOrg.includes('ALL') || fOrg.includes(d._origin);
                     const dstOk = fDst.includes('ALL') || fDst.includes(d._dest);
                     const svcOk = window.selectedService === 'ALL' || d._service === window.selectedService;
                     return dateOk && orgOk && dstOk && svcOk;
                });
                
                prevWeight = prevData.reduce((s,d)=>s+d._weight,0);
                prevPcs = prevData.reduce((s,d)=>s+d._pcs,0);
                prevMB = prevData.length;
            }

            window.updateDiff('kpiWeightDiff', w, prevWeight);
            window.updateDiff('kpiPcsDiff', p, prevPcs);
            window.updateDiff('kpiMBDiff', m, prevMB);

            window.renderMainChart();
            window.renderTimeChart(); 
            window.renderBottomCharts();
            window.renderSlaMatrices();
            window.renderMatrixTable();
            window.aggregateAndRenderTable();
            window.renderBagsealTable(); 
        };

        window.updateDiff = function(id, current, previous) {
            const el = document.getElementById(id);
            if (previous === 0) {
                el.innerText = "-";
                el.className = "text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500";
                return;
            }
            const diff = ((current - previous) / previous) * 100;
            const sign = diff > 0 ? "+" : "";
            el.innerText = `${sign}${diff.toFixed(1)}%`;
            if (diff >= 0) el.className = "text-[10px] font-bold px-1.5 py-0.5 rounded bg-emerald-50 text-emerald-600";
            else el.className = "text-[10px] font-bold px-1.5 py-0.5 rounded bg-rose-50 text-rose-600";
        };

        window.renderBagsealTable = function() {
            const tbody = document.getElementById('bagsealTable');
            tbody.innerHTML = '';
            
            const limit = 200;
            const dataToShow = window.filteredData.slice(0, limit);
            
            let html = `<thead class="bg-slate-50 sticky top-0 z-10 border-b border-slate-200">
                <tr><th class="px-3 py-2 text-left font-bold text-slate-600">No Bagshield</th><th class="px-3 py-2 text-left font-bold text-slate-600">Note</th></tr>
            </thead><tbody>`;

            dataToShow.forEach(d => {
                const note = d._note || '-';
                html += `<tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                    <td class="px-3 py-2 font-mono text-xs text-slate-700 select-all">${d._mb}</td>
                    <td class="px-3 py-2 text-xs text-slate-500 italic">${note}</td>
                </tr>`;
            });
            
            if (window.filteredData.length > limit) {
                html += `<tr><td colspan="2" class="text-center py-2 text-[10px] text-slate-400">...and ${window.filteredData.length - limit} more (use search/filter)</td></tr>`;
            }
            
            html += '</tbody>';
            tbody.innerHTML = html;
        };

        window.copyBagseals = function() {
            const bagseals = window.filteredData.map(d => d._mb).join('\n');
            navigator.clipboard.writeText(bagseals).then(() => {
                window.showToast("Bagseals copied to clipboard", "success");
            }).catch(err => {
                window.showToast("Failed to copy", "error");
            });
        };

        // --- NEW: DOWNLOAD CSV FUNCTION ---
        window.downloadManifestCSV = function() {
            if (!window.filteredData || window.filteredData.length === 0) {
                window.showToast("Tidak ada data untuk diunduh", "info");
                return;
            }

            const headers = [
                "Tanggal Diterima", "Jam", "Destinasi", "Tanggal PA", "Batch",
                "Origin", "SMU", "Flight", "Tanggal Flight", "SLA (Hari)",
                "No Bagseals", "Berat (Kg)", "Pcs", "Vendor", "Service", "Note"
            ];

            // Mapping raw filtered data (which is strictly 1 row per Bagseal)
            const csvRows = window.filteredData.map(d => {
                return [
                    window.formatDate(d._date),
                    d._jam || '-',
                    d._dest || '-',
                    d._dateOrigin ? window.formatDate(d._dateOrigin) : '-',
                    d._batch || '-',
                    d._origin || '-',
                    d._smu || '-',
                    d._flight || '-',
                    d._tglFlight || '-',
                    d._sla || 0,
                    d._mb || '-',
                    d._weight || 0,
                    d._pcs || 0,
                    d._vendor || '-',
                    d._service || '-',
                    (d._note || '').replace(/"/g, '""') 
                ].map(val => `"${val}"`).join(','); 
            });

            const csvContent = [headers.join(','), ...csvRows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `Manifest_Detail_${window.formatInputDate(new Date())}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            window.showToast("Mendownload CSV...", "success");
        };

        window.aggregateAndRenderTable = function() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            // 1. PRE-AGGREGATE: Menggabungkan MB dan Pcs untuk data dengan rincian persis sama
            let aggregatedList = [];
            window.filteredData.forEach(row => {
                const existing = aggregatedList.find(d =>
                    d._date.getTime() === row._date.getTime() &&
                    d._jam === row._jam &&
                    d._dest === row._dest &&
                    (d._dateOrigin?.getTime()||0) === (row._dateOrigin?.getTime()||0) &&
                    d._batch === row._batch &&
                    d._origin === row._origin &&
                    d._smu === row._smu &&
                    d._flight === row._flight &&
                    d._tglFlight === row._tglFlight &&
                    d._sla === row._sla
                );
                if (existing) {
                    existing._mb_count += 1;
                    existing._pcs += row._pcs;
                } else {
                    aggregatedList.push({ ...row, _mb_count: 1 });
                }
            });
            window.aggregatedData = aggregatedList;

            // 2. PIVOT SORTING: Date -> Jam -> Destinasi -> Dst
            aggregatedList.sort((a,b) => {
                if(a._date.getTime() !== b._date.getTime()) return a._date - b._date;
                if(a._jam !== b._jam) return a._jam.localeCompare(b._jam);
                if(a._dest !== b._dest) return a._dest.localeCompare(b._dest);
                if((a._dateOrigin?.getTime()||0) !== (b._dateOrigin?.getTime()||0)) return (a._dateOrigin?.getTime()||0) - (b._dateOrigin?.getTime()||0);
                if(a._batch !== b._batch) return a._batch.localeCompare(b._batch);
                if(a._origin !== b._origin) return a._origin.localeCompare(b._origin);
                if(a._smu !== b._smu) return a._smu.localeCompare(b._smu);
                return a._flight.localeCompare(b._flight);
            });

            // 3. NO PAGINATION (Menampilkan Semua Data)
            const pageData = aggregatedList;
            
            // 4. MEMBUAT DAFTAR BARIS RENDER (Menyisipkan Baris Total)
            let renderRows = [];
            for (let i = 0; i < pageData.length; i++) {
                renderRows.push({ type: 'data', data: pageData[i], date: pageData[i]._date, jam: pageData[i]._jam });

                const isLastInJam = (i === pageData.length - 1) || (pageData[i]._jam !== pageData[i+1]._jam) || (pageData[i]._date.getTime() !== pageData[i+1]._date.getTime());
                const isLastInDate = (i === pageData.length - 1) || (pageData[i]._date.getTime() !== pageData[i+1]._date.getTime());

                // Inject baris Total Jam
                if (isLastInJam) {
                    const trueJamData = aggregatedList.filter(x => x._date.getTime() === pageData[i]._date.getTime() && x._jam === pageData[i]._jam);
                    const sumMb = trueJamData.reduce((s, x) => s + x._mb_count, 0);
                    const sumPcs = trueJamData.reduce((s, x) => s + x._pcs, 0);
                    renderRows.push({ type: 'total_jam', date: pageData[i]._date, jam: pageData[i]._jam, mb: sumMb, pcs: sumPcs });
                }

                // Inject baris Total Tanggal
                if (isLastInDate) {
                    const trueDateData = aggregatedList.filter(x => x._date.getTime() === pageData[i]._date.getTime());
                    const sumMb = trueDateData.reduce((s, x) => s + x._mb_count, 0);
                    const sumPcs = trueDateData.reduce((s, x) => s + x._pcs, 0);
                    renderRows.push({ type: 'total_date', date: pageData[i]._date, mb: sumMb, pcs: sumPcs });
                }
            }

            // 5. MENGHITUNG ROW SPAN UNTUK PIVOT MERGING
            renderRows.forEach(r => {
                r.spanDate = -1; r.spanJam = -1; r.spanDest = -1; r.spanPa = -1;
                r.spanBatch = -1; r.spanOrigin = -1; r.spanSmu = -1; r.spanFlight = -1;
                r.spanTglFlight = -1; r.spanSla = -1;
            });

            // Set default ke 0 (hidden) untuk baris total agar rowspan tidak aktif
            renderRows.forEach(r => {
                if(r.type === 'total_date') { r.spanDate = 0; }
                if(r.type === 'total_jam') { r.spanJam = 0; }
            });

            for (let i = 0; i < renderRows.length; i++) {
                // Span Kolom Tanggal (Membentang melewati baris Total Jam)
                if (renderRows[i].type !== 'total_date' && renderRows[i].spanDate === -1) {
                    let count = 1;
                    for (let j = i + 1; j < renderRows.length; j++) {
                        if (renderRows[j].type === 'total_date') break;
                        if (renderRows[j].date.getTime() === renderRows[i].date.getTime()) {
                            count++; renderRows[j].spanDate = 0;
                        } else break;
                    }
                    renderRows[i].spanDate = count;
                }

                // Span Kolom Lainnya (Hanya membentang di baris data yang persis)
                if (renderRows[i].type === 'data') {
                    const calcDataSpan = (field, matchFn) => {
                        if (renderRows[i]['span'+field] === -1) {
                            let count = 1;
                            for (let j = i + 1; j < renderRows.length; j++) {
                                if (renderRows[j].type !== 'data') break; 
                                if (matchFn(renderRows[i].data, renderRows[j].data)) {
                                    count++; renderRows[j]['span'+field] = 0;
                                } else break;
                            }
                            renderRows[i]['span'+field] = count;
                        }
                    };

                    const pmJam = (a, b) => a._date.getTime()===b._date.getTime() && a._jam===b._jam;
                    const pmDest = (a, b) => pmJam(a,b) && a._dest===b._dest;
                    const pmPa = (a, b) => pmDest(a,b) && (a._dateOrigin?.getTime()||0)===(b._dateOrigin?.getTime()||0);
                    const pmBatch = (a, b) => pmPa(a,b) && a._batch===b._batch;
                    const pmOrigin = (a, b) => pmBatch(a,b) && a._origin===b._origin;
                    const pmSmu = (a, b) => pmOrigin(a,b) && a._smu===b._smu;
                    const pmFlight = (a, b) => pmSmu(a,b) && a._flight===b._flight;
                    const pmTglFlight = (a, b) => pmFlight(a,b) && a._tglFlight===b._tglFlight;
                    const pmSla = (a, b) => pmSmu(a,b) && a._sla===b._sla;

                    calcDataSpan('Jam', pmJam);
                    calcDataSpan('Dest', pmDest);
                    calcDataSpan('Pa', pmPa);
                    calcDataSpan('Batch', pmBatch);
                    calcDataSpan('Origin', pmOrigin);
                    calcDataSpan('Smu', pmSmu);
                    calcDataSpan('Flight', pmFlight);
                    calcDataSpan('TglFlight', pmTglFlight);
                    calcDataSpan('Sla', pmSla);
                }
            }

            // 6. RENDER TABEL HTML
            renderRows.forEach(r => {
                const tr = document.createElement('tr');
                
                if (r.type === 'total_date') {
                    tr.className = "bg-indigo-100 font-black text-indigo-900 border-b-2 border-indigo-300 shadow-sm";
                    tr.innerHTML = `
                        <td colspan="10" class="text-right py-2 px-4 uppercase text-[11px] tracking-wide border-r border-indigo-200">Total Keseluruhan Tanggal ${window.formatDate(r.date)}</td>
                        <td class="text-center font-mono text-indigo-800 border-r border-indigo-200">${window.formatNumber(r.mb)}</td>
                        <td class="text-right text-indigo-900 px-4">${window.formatNumber(r.pcs)}</td>
                    `;
                } else if (r.type === 'total_jam') {
                    tr.className = "bg-slate-100 font-bold text-slate-700 border-y border-slate-300";
                    tr.innerHTML = `
                        <td colspan="9" class="text-right py-1.5 px-4 uppercase text-[10px] tracking-wider border-r border-slate-300 text-slate-500">Total Jam ${r.jam}</td>
                        <td class="text-center font-mono text-slate-700 border-r border-slate-300">${window.formatNumber(r.mb)}</td>
                        <td class="text-right text-slate-800 px-4">${window.formatNumber(r.pcs)}</td>
                    `;
                } else {
                    tr.className = "hover:bg-slate-50 transition border-b border-slate-200";
                    const d = r.data;
                    const addTd = (val, span, cls) => {
                        if (span > 0) {
                            const td = document.createElement('td');
                            td.className = cls + " valign-middle";
                            td.rowSpan = span;
                            td.innerHTML = val;
                            tr.appendChild(td);
                        }
                    };

                    addTd(window.formatDate(d._date), r.spanDate, "text-center font-bold text-slate-800 bg-white border-r border-slate-300 group-col whitespace-nowrap");
                    addTd(d._jam, r.spanJam, "text-center text-slate-700 font-bold border-r border-slate-300 bg-white group-col whitespace-nowrap");
                    addTd(d._dest, r.spanDest, "text-center font-bold text-indigo-800 bg-indigo-50/50 border-r border-slate-300 group-col whitespace-nowrap");
                    addTd(window.formatDate(d._dateOrigin), r.spanPa, "text-left text-slate-500 border-r border-slate-300 bg-white group-col whitespace-nowrap");
                    addTd(d._batch, r.spanBatch, "text-left text-slate-500 border-r border-slate-300 bg-white group-col");
                    addTd(d._origin, r.spanOrigin, "text-left text-slate-700 border-r border-slate-300 bg-white group-col whitespace-nowrap");
                    addTd(d._smu, r.spanSmu, "text-slate-600 font-mono text-[11px] font-medium border-r border-slate-300 valign-middle bg-white group-col whitespace-nowrap");
                    addTd(d._flight, r.spanFlight, "text-left text-slate-900 font-bold border-r border-slate-300 bg-white group-col whitespace-nowrap");
                    addTd(d._tglFlight, r.spanTglFlight, "text-left text-slate-500 border-r border-slate-300 bg-white group-col whitespace-nowrap");
                    
                    if (r.spanSla > 0) {
                        const slaColor = d._sla > 3 ? 'text-rose-600 font-extrabold bg-rose-50' : 'text-emerald-600 font-extrabold bg-emerald-50';
                        addTd(d._sla, r.spanSla, `text-center border-r border-slate-300 group-col ${slaColor}`);
                    }

                    // MB & Pcs merged cleanly
                    addTd(window.formatNumber(d._mb_count), 1, "text-center font-mono font-bold text-indigo-700 border-r border-slate-300 bg-indigo-50/30 group-col");
                    addTd(window.formatNumber(d._pcs), 1, "text-right font-black text-indigo-900 valign-middle bg-indigo-50/50 group-col");
                }
                tbody.appendChild(tr);
            });
            
            document.getElementById('totalCount').textContent = window.aggregatedData.length;
        };

        window.renderMainChart = function() { 
            if(window.chartInstances.main) window.chartInstances.main.destroy();
            const ctx = document.getElementById('mainChart').getContext('2d');
            const agg = {};
            window.filteredData.forEach(d => {
                let sortKey = '';
                if (window.currentChartMode === 'daily') {
                    sortKey = window.toLocalISOString(d._date);
                } else {
                    const y = d._date.getFullYear();
                    const m = String(d._date.getMonth() + 1).padStart(2, '0');
                    sortKey = `${y}-${m}`; 
                }
                agg[sortKey] = (agg[sortKey]||0) + d._pcs;
            });
            
            const sortedKeys = Object.keys(agg).sort();
            const lbls = sortedKeys.map(k => {
                if (window.currentChartMode === 'daily') return k;
                const [y, m] = k.split('-');
                return new Date(y, parseInt(m)-1, 1).toLocaleString('id-ID', {month:'short', year:'numeric'});
            });
            const dataVals = sortedKeys.map(k => agg[k]);

            window.chartInstances.main = new Chart(ctx, {
                type: 'line',
                data: { labels: lbls, datasets: [{ label: 'Total Pcs', data: dataVals, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3 }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    layout: {
                        padding: { top: 35, right: 20, left: 10 }
                    },
                    scales: { 
                        y: { display: false, grace: '5%' }, 
                        x: { grid: { display: false } } 
                    }, 
                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            align: 'end', 
                            anchor: 'end', 
                            color: '#64748b', 
                            font: { weight: 'bold' },
                            formatter: (value) => window.formatNumber(value),
                            clip: false
                        } 
                    } 
                }
            });
        };
        
        window.renderTimeChart = function() {
            if(window.chartInstances.time) window.chartInstances.time.destroy();
            const ctx = document.getElementById('timeChart').getContext('2d');
            const agg = {};
            for(let i=0; i<24; i++) {
                agg[String(i).padStart(2, '0')] = 0;
            }
            
            window.filteredData.forEach(d => {
                if(d._jam && d._jam.includes(':')) {
                    const rawHour = d._jam.split(':')[0].trim();
                    const hourNum = parseInt(rawHour, 10);
                    if (!isNaN(hourNum)) {
                        const hour = String(hourNum).padStart(2, '0');
                        if(agg[hour] !== undefined) agg[hour] += d._pcs;
                    }
                }
            });
            
            const labels = Object.keys(agg).sort();
            window.chartInstances.time = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Qty Pcs',
                        data: labels.map(k => agg[k]),
                        backgroundColor: '#10b981',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { display: false }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#64748b', font: { size: 9 }, formatter: (v) => v > 0 ? window.formatNumber(v) : '' } }
                }
            });
        };

        window.setMainChartMode = function(mode) {
            window.currentChartMode = mode;
            const btnDaily = document.getElementById('btnDaily');
            const btnMonthly = document.getElementById('btnMonthly');
            const baseClasses = "px-6 py-2 rounded-lg text-[10px] font-bold transition-all";
            const activeStyle = "bg-slate-900 text-white shadow-md";
            const inactiveStyle = "bg-white text-slate-600 hover:bg-slate-50";

            if (mode === 'daily') {
                btnDaily.className = `${baseClasses} ${activeStyle}`;
                btnMonthly.className = `${baseClasses} ${inactiveStyle}`;
            } else {
                btnDaily.className = `${baseClasses} ${inactiveStyle}`;
                btnMonthly.className = `${baseClasses} ${activeStyle}`;
            }
            window.renderMainChart();
        };

        window.renderBottomCharts = function() {
            const serviceColors = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6'];

            const renderBar = (id, f, c) => {
                if(window.chartInstances[id]) window.chartInstances[id].destroy();
                const ctx = document.getElementById(id).getContext('2d');
                const agg = {}; window.filteredData.forEach(d => agg[d[f]] = (agg[d[f]]||0) + d._pcs); 
                const s = Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0, 10);
                window.chartInstances[id] = new Chart(ctx, { 
                    type: 'bar', 
                    data: { 
                        labels: s.map(e=>e[0]), 
                        datasets: [{ 
                            data: s.map(e=>e[1]), 
                            backgroundColor: c, 
                            borderRadius: 4,
                            maxBarThickness: 24 
                        }] 
                    }, 
                    options: { 
                        indexAxis: 'y', 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        layout: {
                            padding: { right: 40 }
                        },
                        scales: { 
                            x: { display: false }, 
                            y: { grid: { display: false }, ticks: { font: { size: 10 } } } 
                        }, 
                        plugins: { 
                            legend: { display: false }, 
                            datalabels: { 
                                anchor: 'end', 
                                align: 'end', 
                                color: '#64748b', 
                                font: { size: 10, weight: 'bold' }, 
                                formatter: (v) => window.formatNumber(v) 
                            } 
                        } 
                    } 
                });
            };
            renderBar('chartVendor', '_vendor', '#6366f1');
            renderBar('chartOrigin', '_origin', '#8B5CF6');
            renderBar('chartDestinasi', '_dest', '#F59E0B');
            
            if(window.chartInstances.chartService) window.chartInstances.chartService.destroy();
            const ctxS = document.getElementById('chartService').getContext('2d');
            const aggS = {}; window.filteredData.forEach(d => aggS[d._service] = (aggS[d._service]||0) + d._pcs); 
            const sS = Object.entries(aggS).sort((a,b)=>b[1]-a[1]);
            
            window.chartInstances.chartService = new Chart(ctxS, {
                type: 'doughnut',
                data: {
                    labels: sS.map(e => e[0]),
                    datasets: [{
                        data: sS.map(e => e[1]),
                        backgroundColor: serviceColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { display: false }, 
                        tooltip: { enabled: true },
                        datalabels: { display: false } 
                    }
                }
            });

            const tableEl = document.getElementById('serviceTable');
            let tableHTML = '<tbody>';
            const total = sS.reduce((sum, item) => sum + item[1], 0);

            sS.forEach((item, index) => {
                const serviceName = item[0];
                const val = item[1];
                const pct = total > 0 ? (val / total * 100).toFixed(1) + '%' : '0%';
                const color = serviceColors[index % serviceColors.length];

                tableHTML += `
                    <tr class="border-b border-slate-50 last:border-0">
                        <td class="py-1.5 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" style="background-color: ${color}"></span>
                            <span class="font-semibold">${serviceName}</span>
                        </td>
                        <td class="py-1.5 text-right font-mono">${window.formatNumber(val)}</td>
                        <td class="py-1.5 text-right font-bold text-slate-400">${pct}</td>
                    </tr>
                `;
            });
            tableHTML += '</tbody>';
            tableEl.innerHTML = tableHTML;
        };

        window.renderSlaMatrices = function() {
            const render = (id, f, l) => {
                const t = document.getElementById(id); t.innerHTML = '';
                const agg = {}; 
                window.filteredData.forEach(d => { 
                    const k=d[f]; 
                    if(!agg[k]) agg[k]={u3:0, b35:0, b67:0, o7:0, tot:0, sum:0}; 
                    agg[k].tot+=d._pcs; 
                    agg[k].sum+=(d._sla*d._pcs); 
                    
                    if(d._sla<=2) agg[k].u3+=d._pcs; 
                    else if(d._sla<=5) agg[k].b35+=d._pcs; 
                    else if(d._sla<=7) agg[k].b67+=d._pcs; 
                    else agg[k].o7+=d._pcs; 
                });
                
                let h = `<thead class="sticky top-0 bg-white z-10">
                            <tr>
                                <th class="text-left text-slate-500">${l}</th>
                                <th class="text-center text-emerald-600 bg-emerald-50">0-2H</th>
                                <th class="text-center text-amber-600 bg-amber-50">3-5H</th>
                                <th class="text-center text-orange-600 bg-orange-50">5-7H</th>
                                <th class="text-center text-rose-600 bg-rose-50">>7H</th>
                                <th class="text-center text-slate-800 bg-slate-100">Tot</th>
                                <th class="text-center text-indigo-600 bg-indigo-50">Avg</th>
                            </tr>
                        </thead><tbody>`;
                        
                Object.keys(agg).sort().forEach(k => { 
                    const d=agg[k]; 
                    h += `<tr class="hover:bg-slate-50">
                            <td class="font-bold text-slate-700">${k}</td>
                            <td class="text-center text-emerald-600 font-mono">${window.formatNumber(d.u3)}</td>
                            <td class="text-center text-amber-600 font-mono">${window.formatNumber(d.b35)}</td>
                            <td class="text-center text-orange-600 font-bold font-mono">${window.formatNumber(d.b67)}</td>
                            <td class="text-center text-rose-600 font-bold font-mono">${window.formatNumber(d.o7)}</td>
                            <td class="text-center font-bold bg-slate-50 font-mono">${window.formatNumber(d.tot)}</td>
                            <td class="text-center font-bold text-indigo-600">${(d.tot>0?d.sum/d.tot:0).toFixed(1)}</td>
                          </tr>`; 
                });
                t.innerHTML = h + '</tbody>';
            };
            render('slaOriginTable', '_origin', 'ORIGIN'); render('slaDestTable', '_dest', 'DESTINASI');
        };

        window.changeMatrixPage = function(delta) {
             const uniqueMondays = [...new Set(window.filteredData.map(d => window.getMondayTime(d._date)))].sort((a,b)=>a-b);
             const totalPages = uniqueMondays.length || 1;
             const nextPage = window.matrixPage + delta;
             if(nextPage >= 1 && nextPage <= totalPages) {
                 window.matrixPage = nextPage;
                 window.renderMatrixTable();
             }
        };

        window.renderMatrixTable = function() {
            const uniqueMondays = [...new Set(window.filteredData.map(d => window.getMondayTime(d._date)))].sort((a,b)=>a-b);
            const totalPages = uniqueMondays.length || 1;
            
            if (window.matrixPage > totalPages) window.matrixPage = 1;

            document.getElementById('matrixPageIndicator').innerText = `Minggu ${window.matrixPage} / ${totalPages}`;

            let currentMonday = uniqueMondays.length > 0 ? uniqueMondays[window.matrixPage - 1] : window.getMondayTime(new Date());
            
            const weekDates = [];
            for(let i=0; i<7; i++) {
                const d = new Date(currentMonday);
                d.setDate(d.getDate() + i);
                weekDates.push(d);
            }

            const daysName = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu', 'Minggu'];

            // Get Data only for this week
            const weekStart = weekDates[0].getTime();
            const weekEnd = weekDates[6].getTime() + 24*60*60*1000 - 1; 
            const weekData = window.filteredData.filter(d => d._date.getTime() >= weekStart && d._date.getTime() <= weekEnd);
            
            // Rows are Destinations that have data in this week
            const dests = [...new Set(weekData.map(d => d._dest))].sort();

            const table = document.getElementById('matrixTable');
            
            // --- HEADER ---
            let h = `<thead><tr><th class="text-left sticky left-0 bg-white z-10 w-32 border-r border-slate-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">Destinasi</th>`;
            weekDates.forEach((d, i) => {
                h += `<th class="text-center border-r border-slate-200 min-w-[80px]">
                        <div class="text-[11px] font-bold text-slate-700">${daysName[i]}</div>
                        <div class="text-[9px] font-normal text-slate-400 mt-0.5 tracking-wider">${window.formatDate(d)}</div>
                      </th>`;
            });
            h += `<th class="text-center font-extrabold bg-slate-100 border-l border-slate-300 text-slate-800">TOTAL</th></tr></thead><tbody>`;
            
            if (dests.length === 0) {
                 h += `<tr><td colspan="9" class="text-center py-6 text-slate-400 font-medium">Tidak ada data di rentang minggu ini</td></tr></tbody>`;
                 table.innerHTML = h;
                 return;
            }

            // --- BODY (Destinations) ---
            let grandTotals = [0,0,0,0,0,0,0];
            let grandTotalAll = 0;

            dests.forEach(dst => {
                let r = `<tr><td class="font-bold text-slate-700 sticky left-0 bg-white border-r border-slate-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] whitespace-nowrap">${dst}</td>`;
                let rowTotal = 0;
                
                weekDates.forEach((date, i) => {
                    const t = date.getTime();
                    const v = weekData.filter(d => d._date.getTime() === t && d._dest === dst).reduce((s,d) => s+d._pcs, 0); 
                    rowTotal += v;
                    grandTotals[i] += v;
                    r += `<td class="text-center border-r border-slate-100 ${v>0?'text-slate-800 font-bold bg-indigo-50/20':'text-slate-300'}">${v>0?window.formatNumber(v):'-'}</td>`;
                });
                
                grandTotalAll += rowTotal;
                h += r + `<td class="text-center font-black text-slate-900 bg-slate-50 border-l border-slate-200">${window.formatNumber(rowTotal)}</td></tr>`;
            });

            // --- FOOTER (Grand Totals) ---
            let gRow = `<tr><td class="font-black text-slate-900 sticky left-0 bg-slate-100 border-r border-slate-300 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)] whitespace-nowrap uppercase text-[10px]">TOTAL HARIAN</td>`;
            grandTotals.forEach(gt => {
                gRow += `<td class="text-center font-black text-indigo-700 bg-indigo-50/50 border-r border-indigo-100/50">${gt>0?window.formatNumber(gt):'-'}</td>`;
            });
            gRow += `<td class="text-center font-black text-indigo-900 bg-indigo-100 border-l border-indigo-200">${window.formatNumber(grandTotalAll)}</td></tr>`;

            h += gRow + '</tbody>';
            table.innerHTML = h;
        };

    </script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, getDocs, setDoc, doc, writeBatch, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDNB8muGuCvKuXVmQdJt8MkrAltKn2mtIY",
            authDomain: "dasboardhub-ab72e.firebaseapp.com",
            projectId: "dasboardhub-ab72e",
            storageBucket: "dasboardhub-ab72e.firebasestorage.app",
            messagingSenderId: "126699041682",
            appId: "1:126699041682:web:3d96b34c074108697c474b",
            measurementId: "G-CW183HEGQN"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const statusText = document.getElementById('statusText');
                const connectionStatus = document.getElementById('connectionStatus');
                if(statusText) statusText.textContent = 'Connected';
                if(connectionStatus) connectionStatus.className = "w-1.5 h-1.5 rounded-full bg-emerald-500";
                window.loadDataFromFirestore();
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        window.loadDataFromFirestore = async function() {
            try {
                if(window.showLoading) window.showLoading(true, "Syncing...");
                const qs = await getDocs(collection(db, "inbound_data"));
                if (qs.empty) {
                    if(window.showLoading) window.showLoading(false);
                    return; 
                }
                const docs = [];
                qs.forEach((doc) => {
                    const data = doc.data();
                    data._firestoreId = doc.id; 
                    docs.push(data);
                });
                
                if(window.processRawDataWrapper) {
                    window.processRawDataWrapper(docs);
                    document.getElementById('initialState').classList.add('hidden');
                    document.getElementById('dashboardContent').classList.remove('hidden');
                }
                if(window.showLoading) window.showLoading(false);
            } catch (e) {
                console.error(e);
                if(window.showLoading) window.showLoading(false);
            }
        };

        window.deleteDataForDate = async function(dateString, destString) {
            if(window.showLoading) window.showLoading(true, "Menghapus Data...");
            const targetDate = new Date(dateString);
            targetDate.setHours(0,0,0,0);

            const toDelete = window.rawData.filter(d => {
                if (!d._date || !(d._date instanceof Date) || isNaN(d._date)) return false;
                const dDate = new Date(d._date); // _date ini berasal dari "Tanggal Diterima"
                dDate.setHours(0,0,0,0);
                const matchDate = dDate.getTime() === targetDate.getTime();
                const matchDest = destString === 'ALL' || d._dest === destString;
                return matchDate && matchDest;
            });

            if(toDelete.length === 0) {
                if(window.showLoading) window.showLoading(false);
                window.showToast("Tidak ada data yang cocok untuk dihapus", "info");
                return;
            }

            const batchSize = 450;
            let batches = [];
            let currentBatch = writeBatch(db);
            let count = 0;

            for (const item of toDelete) {
                if(item._firestoreId) {
                    const docRef = doc(db, "inbound_data", item._firestoreId);
                    currentBatch.delete(docRef);
                    count++;
                    if(count % batchSize === 0) {
                        batches.push(currentBatch.commit());
                        currentBatch = writeBatch(db);
                    }
                }
            }
            if(count % batchSize !== 0) batches.push(currentBatch.commit());

            try {
                await Promise.all(batches);
                if(window.showLoading) window.showLoading(false);
                window.showToast(`Berhasil menghapus ${count} data`, "success");
                window.loadDataFromFirestore();
            } catch(e) {
                console.error(e);
                if(window.showLoading) window.showLoading(false);
                window.showToast("Gagal menghapus data", "error");
            }
        };

        // --- NEW DATA UPLOAD FLOW ---
        window.pendingUploadData = [];

        window.uploadCSVToFirestore = function(file) {
            if(window.showLoading) window.showLoading(true, "Menganalisis file...");
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    const data = results.data;
                    
                    // GET EXISTING IDs (Tolak duplicate secara absolut menggunakan _firestoreId)
                    const existingIds = new Set();
                    if(window.rawData) {
                        window.rawData.forEach(d => { if(d._firestoreId) existingIds.add(String(d._firestoreId)); });
                    }
                    if(window.rejectedData) {
                        window.rejectedData.forEach(d => { if(d._firestoreId) existingIds.add(String(d._firestoreId)); });
                    }
                    
                    window.pendingUploadData = [];
                    let duplicateCount = 0;

                    for (const row of data) {
                        const bagseal = String(row['No Bagseals'] || '').trim();
                        const smu = (row['SMU']||'').replace(/\s/g, '');
                        const dest = (row['Destinasi']||'').replace(/\s/g, '');
                        const date = (row['Tanggal DIterima']||'').replace(/[\/\s,]/g, ''); 
                        
                        // ID yang dihasilkan ini adalah ID pasti yang digunakan di Firestore
                        const fallbackId = `${smu}_${dest}_${date}`.substring(0, 100);
                        const id = bagseal || fallbackId;

                        if (!id) continue; // Skip jika datanya benar-benar blank/kosong

                        // Check Duplicate menggunakan ID pasti
                        if (existingIds.has(id)) {
                            duplicateCount++;
                            continue; 
                        }
                        
                        // Tambahkan id ini ke Set() agar jika ada data duplikat di DALAM file CSV yang sama,
                        // sistem juga akan langsung melewatinya.
                        existingIds.add(id);

                        // Add to pending
                        window.pendingUploadData.push(row);
                    }
                    
                    if(window.showLoading) window.showLoading(false);
                    // Reset input so the same file can be selected again if needed
                    document.getElementById('csvFile').value = '';
                    
                    // Show Preview
                    window.openPreviewModal(window.pendingUploadData.length, duplicateCount);
                }
            });
        };

        // Triggered by the "Lanjutkan" button in the Preview Modal
        window.confirmUpload = async function() {
            window.closePreviewModal();
            
            if (window.pendingUploadData.length === 0) {
                window.showToast("Tidak ada data baru untuk diunggah", "info");
                return;
            }

            if(window.showLoading) window.showLoading(true, "Menyimpan ke Cloud...");
            const batchSize = 450; 
            let batches = [];
            let currentBatch = writeBatch(db);
            let count = 0;

            for (const row of window.pendingUploadData) {
                const bagseal = String(row['No Bagseals'] || '').trim();
                const smu = (row['SMU']||'').replace(/\s/g, '');
                const dest = (row['Destinasi']||'').replace(/\s/g, '');
                const date = (row['Tanggal DIterima']||'').replace(/[\/\s,]/g, ''); 
                const id = bagseal || `${smu}_${dest}_${date}`.substring(0, 100) || doc(collection(db, "inbound_data")).id; 

                const docRef = doc(db, "inbound_data", id);
                currentBatch.set(docRef, row);
                count++;
                if (count % batchSize === 0) { batches.push(currentBatch.commit()); currentBatch = writeBatch(db); }
            }
            if (count % batchSize !== 0) batches.push(currentBatch.commit());

            try {
                await Promise.all(batches);
                if(window.showLoading) window.showLoading(false);
                window.pendingUploadData = []; // Clear pending
                window.openSuccessModal(count);
                window.loadDataFromFirestore(); // Reload in background
            } catch (e) {
                console.error(e);
                if(window.showLoading) window.showLoading(false);
                window.showToast("Upload Gagal", "error");
            }
        };

        // Trigger file input dialog
        document.getElementById('csvFile').addEventListener('change', function(e) {
            if(e.target.files.length > 0) window.uploadCSVToFirestore(e.target.files[0]);
        });
    </script>
</body>
</html>