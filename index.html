<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbound Control Tower - Cloud Connected</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base Styles */
        body { 
            background-color: #F0F4F8; 
            color: #334155; 
            font-size: 13px; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-image: radial-gradient(#E2E8F0 1px, transparent 1px); 
            background-size: 24px 24px; 
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        /* Card Styles */
        .fresh-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border-radius: 20px; 
            border: 1px solid #FFFFFF; 
            box-shadow: 0 4px 20px -2px rgba(148, 163, 184, 0.15); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .fresh-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 30px -5px rgba(148, 163, 184, 0.2); 
        }

        /* Inputs */
        .fresh-input { 
            background: #F8FAFC; 
            border: 1px solid #E2E8F0; 
            border-radius: 12px; 
            padding: 8px 12px; 
            font-size: 12px; 
            font-weight: 500; 
            color: #334155; 
            outline: none; 
            transition: all 0.2s; 
        }
        .fresh-input:focus { 
            background: #FFFFFF; 
            border-color: #6366F1; 
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); 
        }

        /* Buttons */
        .btn-gradient { 
            background: linear-gradient(135deg, #4F46E5 0%, #6366F1 100%); 
            color: white; 
            padding: 8px 16px; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 12px; 
            transition: all 0.3s; 
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .btn-gradient:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35); 
            filter: brightness(1.1); 
        }

        .btn-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
            padding: 8px 16px; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 12px; 
            transition: all 0.3s; 
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .btn-danger:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.35); 
            filter: brightness(1.1); 
        }

        .btn-warning { 
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); 
            color: white; 
            padding: 8px 16px; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 12px; 
            transition: all 0.3s; 
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.25); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .btn-warning:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.35); 
            filter: brightness(1.1); 
        }

        /* Toggles */
        .pill-toggle { 
            padding: 6px 14px; 
            border-radius: 50px; 
            font-size: 11px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s; 
            border: 1px solid transparent; 
        }
        .pill-active { 
            background: #0f172a; 
            color: #ffffff; 
            border-color: #0f172a; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
        }
        .pill-inactive { 
            background: #FFFFFF; 
            color: #64748B; 
            border-color: #E2E8F0; 
        }
        .pill-inactive:hover { 
            background: #F8FAFC; 
            color: #334155; 
        }

        /* Table */
        .fresh-table th { 
            text-transform: uppercase; 
            font-size: 10px; 
            font-weight: 700; 
            color: #64748B; 
            letter-spacing: 0.05em; 
            padding: 14px 16px; 
            background: #F8FAFC; 
            border-bottom: 2px solid #94a3b8; 
        }
        .fresh-table td { 
            padding: 12px 16px; 
            border-bottom: 1px solid #cbd5e1; /* Default Border */
            color: #334155; 
            vertical-align: top; 
        }
        
        /* Specific Styles for Merged Cells */
        .valign-middle {
            vertical-align: middle !important;
        }

        .fresh-table tr:hover td { background-color: #F1F5F9; }
        .group-col { background-color: #FFFFFF; border-right: 1px solid #cbd5e1; }
        
        /* BORDERS: Specific Thickness Logic */
        .border-date-group { border-top: 3px solid #1e293b !important; } /* Hitam/Gelap Tebal untuk Tanggal */
        .border-dest-group { border-top: 2px solid #64748b !important; } /* Abu Tebal untuk Destinasi */
        .thick-date-border { border-top: 4px solid #334155 !important; }

        /* Animations */
        @keyframes slideDown { from { transform: translate(-50%, -150%); opacity: 0; } to { transform: translate(-50%, 20px); opacity: 1; } }
        .toast-animate { animation: slideDown 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out; }
        @keyframes fadeInUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .input-label { display: block; font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 4px; margin-left: 2px; }
        
        /* Sticky Filter Background Fix */
        .sticky-filter-wrapper {
            position: sticky;
            top: 72px; /* Adjust based on header height */
            z-index: 30;
            background-color: #F0F4F8; /* Matches body background */
            margin-left: -1rem; /* Counteract container padding */
            margin-right: -1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen selection:bg-indigo-100 selection:text-indigo-700">

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <h3 class="text-slate-800 font-bold text-lg" id="loadingText">Processing...</h3>
    </div>

    <!-- OVERLAYS -->
    <div id="toast-container" class="fixed top-0 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-full max-w-sm"></div>

    <!-- Password Modal -->
    <div id="passwordModal" class="fixed inset-0 z-[60] bg-slate-900/40 backdrop-blur-md hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[320px] p-8 transform scale-95 transition-all duration-300 border border-white/50" id="passwordModalContent">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600 shadow-sm">
                    <i class="fa-solid fa-lock text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800" id="modalTitle">Security Check</h3>
                <p class="text-xs text-slate-500 mt-1" id="modalDesc">Please enter access code</p>
            </div>
            <div class="relative mb-6">
                <input type="password" id="passwordInput" class="w-full text-center py-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-indigo-500 outline-none transition-all text-sm font-mono tracking-[0.5em]" placeholder="••••••" onkeypress="handleEnter(event)">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closePasswordModal()" class="py-2.5 rounded-xl border border-slate-200 text-slate-500 text-xs font-bold hover:bg-slate-50">Cancel</button>
                <button onclick="submitPassword()" class="py-2.5 rounded-xl bg-indigo-600 text-white text-xs font-bold hover:bg-indigo-700 shadow-lg">Verify</button>
            </div>
        </div>
    </div>

    <!-- Delete Date Modal -->
    <div id="deleteModal" class="fixed inset-0 z-[60] bg-slate-900/40 backdrop-blur-md hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-[340px] p-8 transform scale-95 transition-all duration-300 border border-white/50" id="deleteModalContent">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-50 rounded-2xl flex items-center justify-center mx-auto mb-4 text-red-600 shadow-sm">
                    <i class="fa-solid fa-calendar-xmark text-2xl"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Hapus Data</h3>
                <p class="text-xs text-slate-500 mt-1">Pilih tanggal untuk menghapus data</p>
            </div>
            <div class="relative mb-6">
                <label class="input-label mb-2">Tanggal Diterima</label>
                <input type="date" id="deleteDateInput" class="w-full text-center py-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-red-500 outline-none transition-all text-sm font-bold text-slate-700">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeDeleteModal()" class="py-2.5 rounded-xl border border-slate-200 text-slate-500 text-xs font-bold hover:bg-slate-50">Batal</button>
                <button onclick="confirmDelete()" class="py-2.5 rounded-xl bg-red-600 text-white text-xs font-bold hover:bg-red-700 shadow-lg">Hapus</button>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-white/20 shadow-sm h-[72px]">
        <div class="max-w-[1600px] mx-auto px-6 h-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-tr from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                    <i class="fa-solid fa-layer-group text-lg"></i>
                </div>
                <div>
                    <h1 class="text-base font-extrabold text-slate-800 tracking-tight leading-none">Inbound<span class="text-indigo-600">Tower</span></h1>
                    <div class="flex items-center gap-1.5 mt-1">
                        <span id="connectionStatus" class="w-1.5 h-1.5 rounded-full bg-slate-300 animate-pulse"></span>
                        <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wider" id="statusText">Connecting...</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex flex-col items-end">
                    <span class="text-[11px] font-bold text-slate-700" id="currentDateDisplay">-</span>
                    <span class="text-[9px] font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-full">ID-Kal-Sulamp</span>
                </div>
                <div class="h-8 w-[1px] bg-slate-200 hidden md:block"></div>
                
                <button onclick="openDeleteModal()" class="btn-danger flex items-center gap-2 group">
                    <i class="fa-solid fa-trash-can group-hover:rotate-12 transition-transform"></i>
                    <span>Hapus Data</span>
                </button>

                <button onclick="openPasswordModal('upload')" class="btn-gradient flex items-center gap-2 group">
                    <i class="fa-solid fa-database group-hover:rotate-12 transition-transform"></i>
                    <span>Update Data</span>
                </button>
                <input type="file" id="csvFile" accept=".csv" class="hidden">
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow w-full max-w-[1600px] mx-auto px-4 py-4">
        <!-- EMPTY STATE -->
        <div id="initialState" class="flex flex-col items-center justify-center min-h-[60vh] animate-fade-in-up">
            <div class="w-24 h-24 bg-white rounded-3xl flex items-center justify-center border-2 border-dashed border-indigo-200 shadow-xl shadow-indigo-100 mx-auto mb-6">
                <i class="fa-solid fa-satellite-dish text-3xl text-indigo-300 animate-pulse"></i>
            </div>
            <h2 class="text-lg font-bold text-slate-800">Connecting to Cloud...</h2>
            <p class="text-xs text-slate-500 mt-2 font-medium">Fetching inbound data from database.</p>
        </div>

        <!-- DASHBOARD CONTENT -->
        <div id="dashboardContent" class="hidden space-y-6">
            
            <!-- 1. FILTERS & CONTROLS (STICKY BOX) -->
            <div class="sticky-filter-wrapper">
                <div class="fresh-card p-5">
                    <div class="flex flex-col xl:flex-row gap-5 justify-between items-start xl:items-center">
                        <!-- Left: Search & Services -->
                        <div class="w-full xl:flex-1 flex flex-col md:flex-row gap-4 items-end">
                            <div class="relative w-full md:w-64 group">
                                <span class="input-label">Pencarian Global (All Data)</span>
                                <i class="fa-solid fa-magnifying-glass absolute left-3.5 top-[34px] text-slate-400 text-xs group-focus-within:text-indigo-500 transition-colors"></i>
                                <input type="text" id="globalSearch" placeholder="Cari SMU, Flight, Bagseal, Note..." class="fresh-input w-full pl-9 bg-white" oninput="applyFilters()">
                            </div>
                            <div class="w-full">
                                <span class="input-label">Filter Layanan</span>
                                <div class="flex items-center gap-1 overflow-x-auto no-scrollbar max-w-full pb-1" id="serviceToggleContainer"></div>
                            </div>
                        </div>
    
                        <!-- Right: Filters -->
                        <div class="w-full xl:w-auto flex flex-wrap gap-3 justify-end items-end">
                            <div>
                                <span class="input-label">Rentang Tanggal</span>
                                <div class="flex items-center bg-white rounded-xl border border-slate-200 p-1 shadow-sm h-[38px]">
                                    <input type="date" id="filterStartDate" class="text-xs font-semibold text-slate-600 px-2 py-1 outline-none w-28 bg-transparent" onchange="applyFilters()">
                                    <span class="text-slate-300 text-[10px] mx-1 font-bold">SD</span>
                                    <input type="date" id="filterEndDate" class="text-xs font-semibold text-slate-600 px-2 py-1 outline-none w-28 bg-transparent" onchange="applyFilters()">
                                </div>
                            </div>
                            <!-- Multi-Select for Origin -->
                            <div class="relative">
                                <span class="input-label">Filter Origin</span>
                                <button onclick="toggleMulti('originMenu')" class="fresh-input w-32 text-left flex justify-between items-center bg-white h-[38px] relative z-10 group focus:border-indigo-500">
                                    <span id="originLabel" class="truncate text-xs text-slate-600">Semua</span>
                                    <i class="fa-solid fa-chevron-down text-[10px] text-slate-400 group-hover:text-indigo-500 transition-colors"></i>
                                </button>
                                <div id="originMenu" class="hidden absolute top-full left-0 w-48 bg-white border border-slate-200 shadow-xl rounded-xl mt-1 z-[60] max-h-60 overflow-y-auto p-2 flex flex-col gap-1">
                                    <!-- Checkboxes injected via JS -->
                                </div>
                            </div>
                            <!-- Multi-Select for Destinasi -->
                            <div class="relative">
                                <span class="input-label">Filter Destinasi</span>
                                <button onclick="toggleMulti('destMenu')" class="fresh-input w-32 text-left flex justify-between items-center bg-white h-[38px] relative z-10 group focus:border-indigo-500">
                                    <span id="destLabel" class="truncate text-xs text-slate-600">Semua</span>
                                    <i class="fa-solid fa-chevron-down text-[10px] text-slate-400 group-hover:text-indigo-500 transition-colors"></i>
                                </button>
                                <div id="destMenu" class="hidden absolute top-full right-0 md:left-0 w-48 bg-white border border-slate-200 shadow-xl rounded-xl mt-1 z-[60] max-h-60 overflow-y-auto p-2 flex flex-col gap-1">
                                    <!-- Checkboxes injected via JS -->
                                </div>
                            </div>
                            <div>
                                <span class="input-label">&nbsp;</span>
                                <button onclick="resetFilters()" class="w-[38px] h-[38px] flex items-center justify-center bg-white border border-slate-200 rounded-xl hover:bg-slate-50 hover:text-indigo-600 text-slate-400 transition-all shadow-sm" title="Reset Filters"><i class="fa-solid fa-arrows-rotate text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. KPI -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 pt-2">
                <!-- Tonnage -->
                <div class="fresh-card p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500"><i class="fa-solid fa-weight-hanging text-6xl text-indigo-600"></i></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Tonnage</p>
                            <div class="flex items-baseline gap-2 mt-1"><h3 class="text-3xl font-extrabold text-slate-800 tracking-tight" id="kpiWeight">0</h3><span class="text-xs font-bold text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded-md">Kg</span></div>
                            <div class="mt-3 flex items-center gap-2"><span id="kpiWeightDiff" class="text-[10px] font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-500 transition-colors">0%</span><span class="text-[10px] text-slate-400 font-medium">vs periode sebelumnya</span></div>
                        </div>
                    </div>
                </div>
                <!-- Parcel -->
                <div class="fresh-card p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500"><i class="fa-solid fa-box-open text-6xl text-emerald-600"></i></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Parcel</p>
                            <div class="flex items-baseline gap-2 mt-1"><h3 class="text-3xl font-extrabold text-slate-800 tracking-tight" id="kpiPcs">0</h3><span class="text-xs font-bold text-emerald-500 bg-emerald-50 px-2 py-0.5 rounded-md">AWB</span></div>
                            <div class="mt-3 flex items-center gap-2"><span id="kpiPcsDiff" class="text-[10px] font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-500 transition-colors">0%</span><span class="text-[10px] text-slate-400 font-medium">vs periode sebelumnya</span></div>
                        </div>
                    </div>
                </div>
                <!-- Bagseals -->
                <div class="fresh-card p-6 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500"><i class="fa-solid fa-tags text-6xl text-amber-600"></i></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Bagseals</p>
                            <div class="flex items-baseline gap-2 mt-1"><h3 class="text-3xl font-extrabold text-slate-800 tracking-tight" id="kpiMB">0</h3><span class="text-xs font-bold text-amber-500 bg-amber-50 px-2 py-0.5 rounded-md">Seal</span></div>
                            <div class="mt-3 flex items-center gap-2"><span id="kpiMBDiff" class="text-[10px] font-bold px-2 py-1 rounded-full bg-slate-100 text-slate-500 transition-colors">0%</span><span class="text-[10px] text-slate-400 font-medium">vs periode sebelumnya</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. VOLUME CHART -->
            <div class="fresh-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600"><i class="fa-solid fa-chart-area"></i></div><h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide">Volume Trend (Total Pcs)</h3></div>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button id="btnDaily" onclick="setMainChartMode('daily')" class="px-6 py-2 rounded-lg text-[10px] font-bold transition-all bg-slate-900 text-white shadow-md">Daily</button>
                        <button id="btnMonthly" onclick="setMainChartMode('monthly')" class="px-6 py-2 rounded-lg text-[10px] font-bold transition-all bg-white text-slate-600 hover:bg-slate-50">Monthly</button>
                    </div>
                </div>
                <div class="h-72 w-full relative"><canvas id="mainChart"></canvas></div>
            </div>

            <!-- 3.5 TIME TREND & SERVICE SHARE -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Time Trend (75%) -->
                <div class="lg:col-span-3 fresh-card p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-600"><i class="fa-regular fa-clock"></i></div>
                            <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide">Tren Jam Inbound (Qty Pcs)</h3>
                        </div>
                    </div>
                    <div class="h-60 w-full relative"><canvas id="timeChart"></canvas></div>
                </div>

                <!-- Service Share (25%) -->
                <div class="lg:col-span-1 fresh-card p-5 flex flex-col">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-chart-pie text-slate-300"></i> Service Share
                    </h4>
                    <div class="h-[200px] flex items-center justify-center relative mb-4">
                        <canvas id="chartService"></canvas>
                    </div>
                    <div class="overflow-x-auto mt-2">
                        <table class="w-full text-[10px] text-slate-600" id="serviceTable"></table>
                    </div>
                </div>
            </div>

            <!-- 4. DISTRIBUTIONS (REMAINING 3) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="fresh-card p-5 flex flex-col">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><i class="fa-solid fa-building text-slate-300"></i> Top Vendor</h4>
                    <div class="flex-grow min-h-[180px]"><canvas id="chartVendor"></canvas></div>
                </div>
                <div class="fresh-card p-5 flex flex-col">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><i class="fa-solid fa-plane-departure text-slate-300"></i> Origin Dist.</h4>
                    <div class="flex-grow min-h-[180px]"><canvas id="chartOrigin"></canvas></div>
                </div>
                <div class="fresh-card p-5 flex flex-col">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-4 flex items-center gap-2"><i class="fa-solid fa-location-dot text-slate-300"></i> Destinasi Dist.</h4>
                    <div class="flex-grow min-h-[180px]"><canvas id="chartDestinasi"></canvas></div>
                </div>
            </div>
            
            <!-- 4b. REJECTED TABLE -->
            <div class="fresh-card overflow-hidden border-l-4 border-red-500">
                <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-2 bg-red-50/20">
                    <div class="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center text-red-600"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <h3 class="text-[11px] font-bold text-red-600 uppercase">Exception Monitoring: Tolakan Bandara</h3>
                </div>
                <div class="overflow-x-auto custom-scrollbar max-h-80">
                    <table class="fresh-table w-full" id="rejectedTable"></table>
                </div>
            </div>

            <!-- 5a. SLA BREAKDOWN -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                <div class="fresh-card overflow-hidden">
                    <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2"><span class="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span><h3 class="text-[11px] font-bold text-slate-600 uppercase">SLA by Origin</h3></div>
                    <div class="overflow-x-auto custom-scrollbar max-h-64"><table class="fresh-table w-full" id="slaOriginTable"></table></div>
                </div>
                <div class="fresh-card overflow-hidden">
                    <div class="px-5 py-4 border-b border-slate-100 bg-slate-50/50 flex items-center gap-2"><span class="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span><h3 class="text-[11px] font-bold text-slate-600 uppercase">SLA by Destination</h3></div>
                    <div class="overflow-x-auto custom-scrollbar max-h-64"><table class="fresh-table w-full" id="slaDestTable"></table></div>
                </div>
            </div>

            <!-- 5. MATRIX SUMMARY -->
            <div class="fresh-card overflow-hidden mb-5">
                <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-calendar-week text-slate-300"></i>
                        <h3 class="text-[11px] font-bold text-slate-600 uppercase">Daily Matrix Volume (Total Pcs)</h3>
                    </div>
                    <!-- Pagination Controls -->
                     <div class="flex items-center space-x-1 bg-slate-50 p-1 rounded-lg border border-slate-100" id="matrixPaginationContainer">
                        <button onclick="changeMatrixPage(-1)" class="w-7 h-7 flex items-center justify-center rounded-md bg-white text-slate-400 hover:text-indigo-600 hover:shadow-sm transition"><i class="fa-solid fa-chevron-left text-[10px]"></i></button>
                        <span id="matrixPageIndicator" class="px-3 text-[10px] font-mono font-bold text-slate-500">1</span>
                        <button onclick="changeMatrixPage(1)" class="w-7 h-7 flex items-center justify-center rounded-md bg-white text-slate-400 hover:text-indigo-600 hover:shadow-sm transition"><i class="fa-solid fa-chevron-right text-[10px]"></i></button>
                    </div>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="fresh-table w-full" id="matrixTable"></table>
                </div>
            </div>

            <!-- 6. DETAIL DATA TABLE (SPLIT LAYOUT) -->
            <div class="grid grid-cols-12 gap-6 mb-10">
                <!-- Left Column: Bagseals & Notes -->
                <div class="col-span-12 lg:col-span-10 fresh-card overflow-hidden flex flex-col">
                    <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                        <h3 class="text-[11px] font-bold text-slate-700 uppercase flex items-center gap-2">
                            <span class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fa-solid fa-list-check"></i></span>
                            Manifest Summary
                        </h3>
                        <div class="flex items-center space-x-1 bg-slate-50 p-1 rounded-lg border border-slate-100">
                            <button onclick="changePage(-1)" class="w-7 h-7 flex items-center justify-center rounded-md bg-white text-slate-400 hover:text-indigo-600 hover:shadow-sm transition"><i class="fa-solid fa-chevron-left text-[10px]"></i></button>
                            <span id="pageIndicator" class="px-3 text-[10px] font-mono font-bold text-slate-500">1</span>
                            <button onclick="changePage(1)" class="w-7 h-7 flex items-center justify-center rounded-md bg-white text-slate-400 hover:text-indigo-600 hover:shadow-sm transition"><i class="fa-solid fa-chevron-right text-[10px]"></i></button>
                        </div>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="fresh-table w-full">
                            <thead>
                                <tr>
                                    <th class="text-center group-col w-24">Tgl Terima</th>
                                    <th class="text-center group-col bg-indigo-50/50 text-indigo-700 w-24">Destinasi</th>
                                    <th class="text-left group-col w-16">Jam</th>
                                    <th class="text-left group-col w-20">Tgl PA</th>
                                    <th class="text-left group-col w-16">Batch</th>
                                    <th class="text-left group-col">Origin</th>
                                    <th class="text-left">SMU</th>
                                    <th class="text-left">Flight</th>
                                    <th class="text-left w-20">Tgl Flight</th>
                                    <th class="text-center w-16">SLA (H)</th>
                                    <th class="text-center w-16">Total MB</th>
                                    <th class="text-right w-16">Total Pcs</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-slate-50 text-[10px] text-slate-400 text-center border-t border-slate-100 font-mono font-medium">
                        Showing <span id="showingCount" class="text-slate-600">0</span> of <span id="totalCount" class="text-slate-600">0</span> records
                    </div>
                </div>

                <!-- Right Column: Bagseals List -->
                <div class="col-span-12 lg:col-span-2 fresh-card overflow-hidden flex flex-col max-h-[800px]">
                    <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                        <h3 class="text-[11px] font-bold text-slate-700 uppercase flex items-center gap-2">
                            <span class="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"><i class="fa-solid fa-tags"></i></span>
                            Bagshield
                        </h3>
                        <button onclick="copyBagseals()" class="text-[10px] font-bold text-indigo-600 hover:text-indigo-800 bg-indigo-50 px-2 py-1 rounded border border-indigo-100 transition shadow-sm">
                            <i class="fa-regular fa-copy mr-1"></i> Salin
                        </button>
                    </div>
                    <div class="overflow-y-auto custom-scrollbar flex-grow p-0">
                        <table class="w-full text-xs text-left" id="bagsealTable">
                            <!-- JS Generated -->
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- STANDARD SCRIPT (Logic & UI) -->
    <script>
        Chart.register(ChartDataLabels);

        // --- GLOBAL VARIABLES ---
        window.rawData = [];
        window.filteredData = [];
        window.aggregatedData = [];
        window.rejectedData = []; 
        window.chartInstances = {};
        window.currentChartMode = 'daily';
        
        // Manifest Pagination
        window.currentPage = 1;
        window.rowsPerPage = 20;

        // Matrix Pagination
        window.matrixPage = 1;
        window.matrixRowsPerPage = 7;

        window.selectedService = 'ALL';
        let currentAction = ''; 

        document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });

        // --- HELPERS ---
        const parseNum = (str) => {
            if (typeof str === 'number') return str;
            if (!str) return 0;
            let s = str.toString().trim();
            let f = parseFloat(s.replace(',', '.'));
            return isNaN(f) ? 0 : f;
        };

        const toLocalISOString = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const dy = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${dy}`;
        };
        
        const parseDate = (dateStr) => {
            if (!dateStr) return null;
            if (dateStr.includes('/')) { 
                const p = dateStr.split('/'); 
                if (p.length === 3) return new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0])); 
            }
            const m = {'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11};
            const p = dateStr.trim().split(' ');
            if (p.length >= 3) { let y = parseInt(p[2]); if (y < 100) y += 2000; return new Date(y, m[p[1]], parseInt(p[0])); }
            return null;
        };
        const formatDate = (d) => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
        const formatInputDate = (d) => toLocalISOString(d);
        const formatNumber = (num) => num ? num.toLocaleString('id-ID') : '0';

        // --- TOAST ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let icon = '';
            if(type === 'success') icon = '<i class="fa-solid fa-circle-check text-emerald-500 text-lg"></i>';
            else if(type === 'error') icon = '<i class="fa-solid fa-circle-xmark text-rose-500 text-lg"></i>';
            else icon = '<i class="fa-solid fa-circle-info text-indigo-500 text-lg"></i>';

            toast.className = `toast-animate pointer-events-auto flex items-center gap-3 px-5 py-3 bg-white rounded-2xl shadow-hover border border-slate-100 min-w-[240px] justify-center`;
            toast.innerHTML = `${icon}<span class="text-xs font-bold text-slate-600">${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translate(-50%, -20px)'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // --- UI INTERACTION FUNCTIONS ---
        function openPasswordModal(action) {
            currentAction = action;
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = action === 'delete' ? 'Konfirmasi Hapus' : 'Admin Access';
            document.getElementById('modalDesc').textContent = action === 'delete' ? 'Masukkan kode untuk konfirmasi' : 'Please enter access code';
            setTimeout(() => {
                document.getElementById('passwordModal').classList.remove('opacity-0');
                document.getElementById('passwordModalContent').classList.remove('scale-95');
                document.getElementById('passwordModalContent').classList.add('scale-100');
            }, 10);
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('opacity-0');
            document.getElementById('passwordModalContent').classList.remove('scale-100');
            document.getElementById('passwordModalContent').classList.add('scale-95');
            setTimeout(() => document.getElementById('passwordModal').classList.add('hidden'), 300);
        }
        
        function openDeleteModal() {
            document.getElementById('deleteModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('deleteModal').classList.remove('opacity-0');
                document.getElementById('deleteModalContent').classList.remove('scale-95');
                document.getElementById('deleteModalContent').classList.add('scale-100');
            }, 10);
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('opacity-0');
            document.getElementById('deleteModalContent').classList.remove('scale-100');
            document.getElementById('deleteModalContent').classList.add('scale-95');
            setTimeout(() => document.getElementById('deleteModal').classList.add('hidden'), 300);
        }
        
        function confirmDelete() {
             const date = document.getElementById('deleteDateInput').value;
             if(!date) return showToast("Pilih tanggal dulu!", "error");
             closeDeleteModal();
             openPasswordModal('delete');
        }

        function handleEnter(e) { if (e.key === 'Enter') submitPassword(); }

        function submitPassword() {
            const pwd = document.getElementById('passwordInput').value;
            if (pwd === "TAB123") {
                closePasswordModal();
                if(currentAction === 'upload') {
                    showToast("Authorized", "success");
                    setTimeout(() => document.getElementById('csvFile').click(), 500);
                } else if(currentAction === 'delete') {
                    const date = document.getElementById('deleteDateInput').value;
                    if(window.deleteDataForDate) window.deleteDataForDate(date);
                    else showToast("Service Offline", "error");
                }
            } else {
                showToast("Invalid Passcode", "error");
                document.getElementById('passwordInput').value = '';
            }
        }

        function showLoading(show, text) {
            const el = document.getElementById('loadingOverlay');
            if(show) {
                el.classList.remove('hidden');
                document.getElementById('loadingText').textContent = text;
            } else {
                el.classList.add('hidden');
            }
        }

        // --- PROCESSING (Global wrapper) ---
        window.processRawDataWrapper = function(data) {
            const validData = [];
            const rejectedData = [];

            data.forEach(row => {
                const tglTerimaStr = row['Tanggal DIterima'] || '';
                
                let vendor = (row['VENDOR'] || 'N/A').toUpperCase();
                let origin = (row['Origin'] || 'N/A').toUpperCase();
                let dest = (row['Destinasi'] || 'Unknown').toUpperCase();
                let batch = (row['BATCH'] || 'N/A').toString().toUpperCase();
                let service = (row['SERVICE'] || 'N/A').toUpperCase();
                if (service === 'REG') service = 'REGULER';
                
                const rawFlight = row['FLIGHT'] || '-';
                let cleanFlight = rawFlight.toUpperCase();
                if (service === 'REGULER') cleanFlight = rawFlight.replace(/[\s-]/g, '').toUpperCase();
                
                if (tglTerimaStr.toLowerCase().includes('tolakan')) {
                    rejectedData.push({
                        _tglPA: parseDate(row['Tanggal']),
                        _origin: origin,
                        _vendor: vendor,
                        _dest: dest,
                        _smu: row['SMU'] || '-',
                        _flight: cleanFlight,
                        _batch: batch,
                        _pcs: parseNum(row['Kuantitas Paket (Awb)']),
                        _weight: parseNum(row['Berat Total (kg)']),
                        _note: row['Note'] || row['CATATAN'] || tglTerimaStr,
                        _tglFlight: row['TANGGAL FLIGHT'],
                        _etd: row['ETD'],
                        _mb: row['No Bagseals'],
                        _service: service
                    });
                    return; 
                }

                const tglTerima = parseDate(tglTerimaStr);
                const tglOrigin = parseDate(row['Tanggal']); 
                
                if (tglTerima) {
                    let sla = 0;
                    if (tglOrigin) {
                        const diff = tglTerima - tglOrigin;
                        sla = Math.ceil(diff / (1000 * 60 * 60 * 24));
                    }

                    // KEY CHANGE: _pcs comes from 'Kuantitas Paket (Awb)'
                    validData.push({
                        ...row,
                        _date: tglTerima,
                        _dateOrigin: tglOrigin,
                        _weight: parseNum(row['Berat Total (kg)']),
                        _pcs: parseNum(row['Kuantitas Paket (Awb)']), 
                        _vendor: vendor,
                        _origin: origin,
                        _dest: dest,
                        _service: service,
                        _batch: batch,
                        _jam: row['JAM'] || '-',
                        _smu: row['SMU'] || '-',
                        _flight: cleanFlight,
                        _tglFlight: row['TANGGAL FLIGHT'] || '-',
                        _mb: row['No Bagseals'] || '-',
                        _note: row['Note'] || row['CATATAN'] || '',
                        _sla: sla,
                        _firestoreId: row._firestoreId 
                    });
                }
            });

            window.rawData = validData;
            window.rejectedData = rejectedData;

            populateFilters();
            renderRejectedTable();
            
            const dates = window.rawData.map(d => d._date).sort((a,b) => a-b);
            if (dates.length > 0) {
                document.getElementById('filterStartDate').value = formatInputDate(dates[0]);
                document.getElementById('filterEndDate').value = formatInputDate(dates[dates.length-1]);
            }

            applyFilters();
        };

        // --- NEW REJECTED TABLE RENDERER ---
        function renderRejectedTable() {
            const table = document.getElementById('rejectedTable');
            if (window.rejectedData.length === 0) {
                table.innerHTML = `<tr><td class="p-4 text-center text-slate-400 italic">Tidak ada data tolakan</td></tr>`;
                return;
            }
            let html = `<thead class="bg-red-50"><tr>
                <th class="text-left text-red-600">Tgl PA</th>
                <th class="text-center text-red-600">Batch</th>
                <th class="text-left text-red-600">Origin</th>
                <th class="text-left text-red-600">Vendor</th>
                <th class="text-left text-red-600">Service</th>
                <th class="text-left text-red-600">Destinasi</th>
                <th class="text-left text-red-600">SMU</th>
                <th class="text-left text-red-600">Flight</th>
                <th class="text-left text-red-600">Tgl Flight</th>
                <th class="text-left text-red-600">ETD</th>
                <th class="text-center text-red-600">No Bagseals</th>
                <th class="text-right text-red-600">Berat (Kg)</th>
                <th class="text-right text-red-600">Pcs</th>
                <th class="text-left text-red-600">Note</th>
            </tr></thead><tbody>`;

            window.rejectedData.forEach(d => {
                const datePa = d._tglPA ? formatDate(d._tglPA) : '-';
                html += `<tr class="hover:bg-red-50/30">
                    <td class="font-medium text-slate-600">${datePa}</td>
                    <td class="text-center">${d._batch}</td>
                    <td>${d._origin}</td>
                    <td>${d._vendor}</td>
                    <td>${d._service}</td>
                    <td class="font-bold text-slate-700">${d._dest}</td>
                    <td class="font-mono text-xs">${d._smu}</td>
                    <td>${d._flight}</td>
                    <td>${d._tglFlight}</td>
                    <td>${d._etd}</td>
                    <td class="text-center font-mono text-xs">${d._mb}</td>
                    <td class="text-right">${formatNumber(d._weight)}</td>
                    <td class="text-right font-bold">${formatNumber(d._pcs)}</td>
                    <td class="text-xs text-red-500 italic">${d._note}</td>
                </tr>`;
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        // --- FILTERS ---
        function populateFilters() {
            // Helper for Multi-Select
            const populateMulti = (menuId, labelId, field) => {
                const menu = document.getElementById(menuId);
                const opts = [...new Set(window.rawData.map(d => d[field]))].sort();
                
                let html = `
                    <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-indigo-50 rounded cursor-pointer transition-colors border-b border-slate-100 mb-1">
                        <input type="checkbox" value="ALL" class="accent-indigo-600 w-3.5 h-3.5" onchange="handleMultiChange('${menuId}', '${labelId}', this)" checked>
                        <span class="text-xs font-bold text-slate-700">Pilih Semua</span>
                    </label>
                `;
                
                opts.forEach(o => {
                    html += `
                    <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-slate-50 rounded cursor-pointer transition-colors">
                        <input type="checkbox" value="${o}" class="accent-indigo-600 w-3.5 h-3.5 item-checkbox" onchange="handleMultiChange('${menuId}', '${labelId}', this)" checked>
                        <span class="text-xs text-slate-600">${o}</span>
                    </label>`;
                });
                menu.innerHTML = html;
                updateMultiLabel(menuId, labelId);
            };

            populateMulti('originMenu', 'originLabel', '_origin');
            populateMulti('destMenu', 'destLabel', '_dest');

            const services = [...new Set(window.rawData.map(d => d._service))].sort();
            const container = document.getElementById('serviceToggleContainer');
            container.innerHTML = '';
            container.appendChild(createToggleBtn('ALL', 'ALL'));
            services.forEach(s => container.appendChild(createToggleBtn(s, s)));
            updateToggleVisuals();
        }

        // --- NEW: Multi Select Logic ---
        window.toggleMulti = (id) => {
            const el = document.getElementById(id);
            // Close others
            ['originMenu', 'destMenu'].forEach(m => {
                if(m !== id) document.getElementById(m).classList.add('hidden');
            });
            el.classList.toggle('hidden');
        };

        // Close dropdowns when clicking outside
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                document.getElementById('originMenu').classList.add('hidden');
                document.getElementById('destMenu').classList.add('hidden');
            }
        });

        window.handleMultiChange = (menuId, labelId, checkbox) => {
            const menu = document.getElementById(menuId);
            const allChk = menu.querySelector('input[value="ALL"]');
            const items = menu.querySelectorAll('input.item-checkbox');

            if (checkbox.value === 'ALL') {
                items.forEach(i => i.checked = checkbox.checked);
            } else {
                const allChecked = [...items].every(i => i.checked);
                allChk.checked = allChecked;
                if (!checkbox.checked) allChk.checked = false;
            }
            updateMultiLabel(menuId, labelId);
            applyFilters();
        };

        window.updateMultiLabel = (menuId, labelId) => {
            const menu = document.getElementById(menuId);
            const items = menu.querySelectorAll('input.item-checkbox');
            const checked = [...items].filter(i => i.checked);
            const label = document.getElementById(labelId);
            
            if (checked.length === 0) {
                label.textContent = "Pilih...";
                label.classList.add("text-slate-400");
            } else if (checked.length === items.length) {
                label.textContent = "Semua";
                label.classList.remove("text-slate-400", "font-bold", "text-indigo-600");
            } else {
                label.textContent = `${checked.length} Terpilih`;
                label.classList.add("font-bold", "text-indigo-600");
                label.classList.remove("text-slate-400");
            }
        };

        window.getSelectedValues = (menuId) => {
            const menu = document.getElementById(menuId);
            const allChk = menu.querySelector('input[value="ALL"]');
            if (allChk && allChk.checked) return ['ALL'];
            
            return [...menu.querySelectorAll('input.item-checkbox:checked')].map(i => i.value);
        };

        function createToggleBtn(l, v) {
            const btn = document.createElement('button');
            btn.textContent = l; btn.dataset.value = v;
            btn.className = "pill-toggle mr-1 mb-1";
            btn.onclick = () => { window.selectedService = v; updateToggleVisuals(); applyFilters(); };
            return btn;
        }

        function updateToggleVisuals() {
            document.querySelectorAll('#serviceToggleContainer button').forEach(b => {
                if (b.dataset.value === window.selectedService) b.className = "pill-toggle mr-1 mb-1 pill-active";
                else b.className = "pill-toggle mr-1 mb-1 pill-inactive";
            });
        }

        function resetFilters() {
            // Reset Multi Selects
            ['originMenu', 'destMenu'].forEach(id => {
                const inputs = document.querySelectorAll(`#${id} input`);
                inputs.forEach(i => i.checked = true);
                const labelId = id === 'originMenu' ? 'originLabel' : 'destLabel';
                updateMultiLabel(id, labelId);
            });
            
            document.getElementById('globalSearch').value = '';
            window.selectedService = 'ALL';
            updateToggleVisuals();
            const dates = window.rawData.map(d => d._date).sort((a,b) => a-b);
            if(dates.length) {
                document.getElementById('filterStartDate').value = formatInputDate(dates[0]);
                document.getElementById('filterEndDate').value = formatInputDate(dates[dates.length-1]);
            }
            applyFilters();
            showToast("Reset Complete", "info");
        }

        function applyFilters() {
            const startVal = document.getElementById('filterStartDate').value;
            const endVal = document.getElementById('filterEndDate').value;

            // Construct dates manually from components to ensure local midnight time
            let sDate = null, eDate = null;
            if(startVal) {
                const p = startVal.split('-');
                sDate = new Date(p[0], p[1]-1, p[2]); 
            }
            if(endVal) {
                const p = endVal.split('-');
                eDate = new Date(p[0], p[1]-1, p[2]); 
                eDate.setHours(23,59,59,999); 
            }

            // Get Multi Select Values
            const fOrg = window.getSelectedValues('originMenu');
            const fDst = window.getSelectedValues('destMenu');
            
            const search = document.getElementById('globalSearch').value.toUpperCase();

            window.filteredData = window.rawData.filter(d => {
                // Ensure d._date is also valid for comparison
                if(!d._date) return false;
                
                const dateOk = (!sDate || d._date >= sDate) && (!eDate || d._date <= eDate);
                // Array inclusion check for multi-select
                const orgOk = fOrg.includes('ALL') || fOrg.includes(d._origin);
                const dstOk = fDst.includes('ALL') || fDst.includes(d._dest);
                
                const svcOk = window.selectedService === 'ALL' || d._service === window.selectedService;
                
                // IMPROVED: Global Search across ALL relevant fields
                let searchOk = true;
                if(search) {
                    const haystack = [
                        d._smu, 
                        d._flight, 
                        d._vendor, 
                        d._origin, 
                        d._dest,
                        d._batch,
                        d._mb,      // Bagseals
                        d._note,    // Notes
                        d._service
                    ].join(' ').toUpperCase();
                    searchOk = haystack.includes(search);
                }
                
                return dateOk && orgOk && dstOk && svcOk && searchOk;
            });

            window.currentPage = 1;
            window.matrixPage = 1; 
            updateDashboard();
        }

        // --- DASHBOARD UPDATER ---
        function updateDashboard() {
            const fd = window.filteredData;
            const w = fd.reduce((a,b) => a+b._weight, 0);
            const p = fd.reduce((a,b) => a+b._pcs, 0); 
            const m = fd.length;
            
            document.getElementById('kpiWeight').innerText = formatNumber(w);
            document.getElementById('kpiMB').innerText = formatNumber(m);
            document.getElementById('kpiPcs').innerText = formatNumber(p);

            const startStr = document.getElementById('filterStartDate').value;
            const endStr = document.getElementById('filterEndDate').value;
            let prevWeight = 0, prevPcs = 0, prevMB = 0;

            if(startStr && endStr) {
                const sDate = new Date(startStr.split('-')[0], startStr.split('-')[1]-1, startStr.split('-')[2]);
                const eDate = new Date(endStr.split('-')[0], endStr.split('-')[1]-1, endStr.split('-')[2]);
                const oneDay = 24*60*60*1000;
                const diffDays = Math.round(Math.abs((eDate - sDate) / oneDay)) + 1;
                const prevEndDate = new Date(sDate);
                prevEndDate.setDate(prevEndDate.getDate() - 1);
                prevEndDate.setHours(23,59,59,999);
                const prevStartDate = new Date(prevEndDate);
                prevStartDate.setDate(prevStartDate.getDate() - diffDays + 1); 
                prevStartDate.setHours(0,0,0,0);
                
                // CHANGED: Helper logic for previous period comparison with multi-select
                const fOrg = window.getSelectedValues('originMenu');
                const fDst = window.getSelectedValues('destMenu');

                const prevData = window.rawData.filter(d => {
                     const dateOk = d._date >= prevStartDate && d._date <= prevEndDate;
                     const orgOk = fOrg.includes('ALL') || fOrg.includes(d._origin);
                     const dstOk = fDst.includes('ALL') || fDst.includes(d._dest);
                     const svcOk = window.selectedService === 'ALL' || d._service === window.selectedService;
                     return dateOk && orgOk && dstOk && svcOk;
                });
                
                prevWeight = prevData.reduce((s,d)=>s+d._weight,0);
                prevPcs = prevData.reduce((s,d)=>s+d._pcs,0);
                prevMB = prevData.length;
            }

            updateDiff('kpiWeightDiff', w, prevWeight);
            updateDiff('kpiPcsDiff', p, prevPcs);
            updateDiff('kpiMBDiff', m, prevMB);

            renderMainChart();
            renderTimeChart(); // NEW
            renderBottomCharts();
            renderSlaMatrices();
            renderMatrixTable();
            aggregateAndRenderTable();
            renderBagsealTable(); // NEW
        }

        function updateDiff(id, current, previous) {
            const el = document.getElementById(id);
            if (previous === 0) {
                el.innerText = "-";
                el.className = "text-[10px] font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-500";
                return;
            }
            const diff = ((current - previous) / previous) * 100;
            const sign = diff > 0 ? "+" : "";
            el.innerText = `${sign}${diff.toFixed(1)}%`;
            if (diff >= 0) el.className = "text-[10px] font-bold px-1.5 py-0.5 rounded bg-emerald-50 text-emerald-600";
            else el.className = "text-[10px] font-bold px-1.5 py-0.5 rounded bg-rose-50 text-rose-600";
        }

        // --- NEW: BAGSEAL TABLE RENDERER ---
        function renderBagsealTable() {
            const tbody = document.getElementById('bagsealTable');
            tbody.innerHTML = '';
            
            const limit = 200;
            const dataToShow = window.filteredData.slice(0, limit);
            
            let html = `<thead class="bg-slate-50 sticky top-0 z-10 border-b border-slate-200">
                <tr><th class="px-3 py-2 text-left font-bold text-slate-600">No Bagshield</th><th class="px-3 py-2 text-left font-bold text-slate-600">Note</th></tr>
            </thead><tbody>`;

            dataToShow.forEach(d => {
                const note = d._note || '-';
                html += `<tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                    <td class="px-3 py-2 font-mono text-xs text-slate-700 select-all">${d._mb}</td>
                    <td class="px-3 py-2 text-xs text-slate-500 italic">${note}</td>
                </tr>`;
            });
            
            if (window.filteredData.length > limit) {
                html += `<tr><td colspan="2" class="text-center py-2 text-[10px] text-slate-400">...and ${window.filteredData.length - limit} more (use search/filter)</td></tr>`;
            }
            
            html += '</tbody>';
            tbody.innerHTML = html;
        }

        // --- NEW: COPY BAGSEALS FUNCTION ---
        function copyBagseals() {
            const bagseals = window.filteredData.map(d => d._mb).join('\n');
            navigator.clipboard.writeText(bagseals).then(() => {
                showToast("Bagseals copied to clipboard", "success");
            }).catch(err => {
                showToast("Failed to copy", "error");
            });
        }
        window.copyBagseals = copyBagseals;

        // --- AGGREGATED TABLE (MANIFEST) ---
        function aggregateAndRenderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            // Use filteredData directly (detail rows)
            let displayData = [...window.filteredData];
            
            // SORTING: Date -> Dest -> Jam -> Flight
            displayData.sort((a,b) => {
                if(a._date.getTime() !== b._date.getTime()) return a._date - b._date;
                if(a._dest !== b._dest) return a._dest < b._dest ? -1 : 1; 
                if(a._jam !== b._jam) return a._jam.localeCompare(b._jam);
                return a._flight.localeCompare(b._flight);
            });

            const start = (window.currentPage - 1) * window.rowsPerPage;
            const pageData = displayData.slice(start, start + window.rowsPerPage);
            
            // Span Calculation
            const spans = { 
                date: [], dest: [], jam: [], pa: [], sla: [], batch: [], origin: [], flight: [], tglFlight: [], mb: [], pcs: [] 
            };
            for(let k in spans) spans[k] = new Array(pageData.length).fill(0);

            // Generic Calculator
            const calcSpan = (field, parentMatch, selfMatchField) => {
                for(let i=0; i<pageData.length; i++) {
                    if(spans[field][i] === -1) continue;
                    let c = 1;
                    for(let j=i+1; j<pageData.length; j++) {
                        const mParent = parentMatch(pageData[i], pageData[j]);
                        const fName = selfMatchField ? selfMatchField : '_'+field;
                        const mSelf = pageData[i][fName] === pageData[j][fName];
                        if(mParent && mSelf) { c++; spans[field][j] = -1; } else break;
                    }
                    spans[field][i] = c;
                }
            };

            // Hierarchy
            const pmDate = (a,b) => a._date.getTime()===b._date.getTime() && a._dest===b._dest; 
            
            for(let i=0; i<pageData.length; i++) {
                if(spans.date[i] === -1) continue;
                let c = 1;
                for(let j=i+1; j<pageData.length; j++) {
                    if(pmDate(pageData[i], pageData[j])) { c++; spans.date[j] = -1; } else break;
                }
                spans.date[i] = c;
            }

            calcSpan('dest', pmDate); 
            const pmDest = (a,b) => pmDate(a,b) && a._dest===b._dest;
            calcSpan('jam', pmDest);
            const pmJam = (a,b) => pmDest(a,b) && a._jam===b._jam;
            
            calcSpan('pa', pmJam, '_dateOrigin');
            calcSpan('batch', pmJam);
            calcSpan('origin', pmJam);
            calcSpan('flight', pmJam);
            calcSpan('tglFlight', pmJam);
            calcSpan('sla', pmJam);

            // Helper to calculate sums for a range
            const calcSum = (startIdx, span) => {
                let mb = 0, pcs = 0;
                for(let k=0; k<span; k++) {
                    if (startIdx + k < pageData.length) {
                        mb += 1; // Each row is 1 MB
                        pcs += pageData[startIdx + k]._pcs;
                    }
                }
                return { mb, pcs };
            };

            pageData.forEach((d, i) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-300"; 
                
                if(spans.date[i] > 0 && i > 0) tr.classList.add("thick-date-border");

                const addTd = (f, txt, cls, isHtml=false) => {
                    if(spans[f][i] > 0) {
                        const td = document.createElement('td');
                        td.className = cls + " valign-middle"; 
                        td.rowSpan = spans[f][i];
                        if(isHtml) td.innerHTML = txt;
                        else td.textContent = txt;
                        tr.appendChild(td);
                    }
                };

                // DATE CELL with Summary
                if (spans.date[i] > 0) {
                    const totals = calcSum(i, spans.date[i]);
                    const html = `
                        <div class="flex flex-col items-center gap-1">
                            <span class="text-sm">${formatDate(d._date)}</span>
                            <div class="w-full bg-indigo-50 border border-indigo-100 rounded p-1 text-[9px] leading-tight">
                                <div class="font-bold text-indigo-700 uppercase mb-0.5">Total Tgl</div>
                                <div class="flex justify-between px-1">
                                    <span class="text-slate-600 font-mono">${totals.mb} MB</span>
                                    <span class="text-slate-800 font-bold font-mono">${formatNumber(totals.pcs)} Pcs</span>
                                </div>
                            </div>
                        </div>
                    `;
                    addTd('date', html, "text-center font-bold text-slate-800 bg-white border-r border-slate-300 group-col", true);
                }

                addTd('dest', d._dest, "text-center font-bold text-indigo-800 bg-indigo-50 border-r border-slate-300 group-col");
                
                // JAM CELL with Summary
                if (spans.jam[i] > 0) {
                    const totals = calcSum(i, spans.jam[i]);
                    const html = `
                        <div class="flex flex-col gap-0.5">
                            <span class="text-sm font-bold text-slate-700">${d._jam}</span>
                            <span class="text-[9px] font-medium text-slate-500 bg-slate-100 px-1 rounded border border-slate-200 inline-block text-center">
                                ${totals.mb} MB | ${formatNumber(totals.pcs)} Pcs
                            </span>
                        </div>
                    `;
                    addTd('jam', html, "text-left text-slate-700 font-medium border-r border-slate-300 bg-white group-col", true);
                }

                addTd('pa', formatDate(d._dateOrigin), "text-left text-slate-500 border-r border-slate-300 bg-white group-col");
                addTd('batch', d._batch, "text-left text-slate-500 border-r border-slate-300 bg-white group-col");
                addTd('origin', d._origin, "text-left text-slate-700 border-r border-slate-300 bg-white group-col");

                const smuTd = document.createElement('td');
                smuTd.className = "text-slate-600 font-mono text-[11px] border-r border-slate-300 valign-middle font-medium";
                smuTd.textContent = d._smu;
                tr.appendChild(smuTd);

                addTd('flight', d._flight, "text-left text-slate-900 font-bold border-r border-slate-300 bg-white");
                addTd('tglFlight', d._tglFlight, "text-left text-slate-500 border-r border-slate-300 bg-white");
                
                // SLA Moved here
                if (spans.sla[i] > 0) {
                    const slaColor = d._sla > 3 ? 'text-rose-600 font-extrabold bg-rose-50' : 'text-emerald-600 font-extrabold bg-emerald-50';
                    const td = document.createElement('td');
                    td.className = `text-center border-r border-slate-300 group-col valign-middle ${slaColor}`;
                    td.rowSpan = spans.sla[i];
                    td.textContent = d._sla;
                    tr.appendChild(td);
                }

                // Individual Rows for MB & PCS (No Merge)
                const mbTd = document.createElement('td');
                mbTd.className = "text-center font-mono font-bold text-slate-600 border-r border-slate-300 valign-middle bg-white";
                mbTd.textContent = "1"; 
                tr.appendChild(mbTd);

                const pcsTd = document.createElement('td');
                pcsTd.className = "text-right font-black text-slate-900 valign-middle bg-white";
                pcsTd.textContent = formatNumber(d._pcs);
                tr.appendChild(pcsTd);

                tbody.appendChild(tr);
            });
            
            document.getElementById('showingCount').textContent = `${Math.min(start+1, window.aggregatedData.length)} - ${Math.min(start+pageData.length, window.aggregatedData.length)}`;
            document.getElementById('totalCount').textContent = window.aggregatedData.length;
            document.getElementById('pageIndicator').textContent = window.currentPage;
        }

        // --- CHARTS & MATRICES (Using Global Functions) ---
        function renderMainChart() { 
            if(window.chartInstances.main) window.chartInstances.main.destroy();
            const ctx = document.getElementById('mainChart').getContext('2d');
            const agg = {};
            window.filteredData.forEach(d => {
                // FIX: Use manual date formatting to avoid timezone shifts
                const k = window.currentChartMode === 'daily' ? toLocalISOString(d._date) : d._date.toLocaleString('id-ID', {month:'short', year:'numeric'});
                agg[k] = (agg[k]||0) + d._pcs;
            });
            // FIX: Sort keys (Dates) properly for X axis
            const lbls = Object.keys(agg).sort(); // YYYY-MM-DD sorts correctly
            window.chartInstances.main = new Chart(ctx, {
                type: 'line',
                data: { labels: lbls, datasets: [{ label: 'Total Pcs', data: lbls.map(k=>agg[k]), borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', fill: true, tension: 0.3 }] },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { display: false }, 
                        x: { grid: { display: false } } 
                    }, 
                    plugins: { legend: { display: false }, datalabels: { align: 'end', anchor: 'end', color: '#64748b', font: { weight: 'bold' } } } 
                }
            });
        }
        
        // --- NEW: TIME TREND CHART ---
        function renderTimeChart() {
            if(window.chartInstances.time) window.chartInstances.time.destroy();
            const ctx = document.getElementById('timeChart').getContext('2d');
            const agg = {};
            // Init 00-23
            for(let i=0; i<24; i++) {
                agg[String(i).padStart(2, '0')] = 0;
            }
            
            window.filteredData.forEach(d => {
                // Extract Hour from JAM (assuming format HH:mm)
                if(d._jam && d._jam.includes(':')) {
                    const hour = d._jam.split(':')[0];
                    if(agg[hour] !== undefined) agg[hour] += d._pcs;
                }
            });
            
            const labels = Object.keys(agg).sort();
            window.chartInstances.time = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Qty Pcs',
                        data: labels.map(k => agg[k]),
                        backgroundColor: '#10b981',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { display: false }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#64748b', font: { size: 9 }, formatter: (v) => v > 0 ? formatNumber(v) : '' } }
                }
            });
        }

        window.setMainChartMode = function(mode) {
            window.currentChartMode = mode;
            const btnDaily = document.getElementById('btnDaily');
            const btnMonthly = document.getElementById('btnMonthly');
            const baseClasses = "px-6 py-2 rounded-lg text-[10px] font-bold transition-all";
            const activeStyle = "bg-slate-900 text-white shadow-md";
            const inactiveStyle = "bg-white text-slate-600 hover:bg-slate-50";

            if (mode === 'daily') {
                btnDaily.className = `${baseClasses} ${activeStyle}`;
                btnMonthly.className = `${baseClasses} ${inactiveStyle}`;
            } else {
                btnDaily.className = `${baseClasses} ${inactiveStyle}`;
                btnMonthly.className = `${baseClasses} ${activeStyle}`;
            }
            renderMainChart();
        }

        function renderBottomCharts() {
            const serviceColors = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6'];

            const renderBar = (id, f, c) => {
                if(window.chartInstances[id]) window.chartInstances[id].destroy();
                const ctx = document.getElementById(id).getContext('2d');
                const agg = {}; window.filteredData.forEach(d => agg[d[f]] = (agg[d[f]]||0) + d._pcs); // Summing Pcs
                const s = Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0, 10);
                window.chartInstances[id] = new Chart(ctx, { type: 'bar', data: { labels: s.map(e=>e[0]), datasets: [{ data: s.map(e=>e[1]), backgroundColor: c, borderRadius: 6 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { display: false } } }, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', color: '#6b7280', font: { size: 9 }, formatter: (v) => formatNumber(v) } } } });
            };
            renderBar('chartVendor', '_vendor', '#6366f1');
            renderBar('chartOrigin', '_origin', '#8B5CF6');
            renderBar('chartDestinasi', '_dest', '#F59E0B');
            
            if(window.chartInstances.chartService) window.chartInstances.chartService.destroy();
            const ctxS = document.getElementById('chartService').getContext('2d');
            const aggS = {}; window.filteredData.forEach(d => aggS[d._service] = (aggS[d._service]||0) + d._pcs); 
            const sS = Object.entries(aggS).sort((a,b)=>b[1]-a[1]);
            
            window.chartInstances.chartService = new Chart(ctxS, {
                type: 'doughnut',
                data: {
                    labels: sS.map(e => e[0]),
                    datasets: [{
                        data: sS.map(e => e[1]),
                        backgroundColor: serviceColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { display: false }, 
                        tooltip: { enabled: true },
                        datalabels: { display: false } 
                    }
                }
            });

            const tableEl = document.getElementById('serviceTable');
            let tableHTML = '<tbody>';
            const total = sS.reduce((sum, item) => sum + item[1], 0);

            sS.forEach((item, index) => {
                const serviceName = item[0];
                const val = item[1];
                const pct = total > 0 ? (val / total * 100).toFixed(1) + '%' : '0%';
                const color = serviceColors[index % serviceColors.length];

                tableHTML += `
                    <tr class="border-b border-slate-50 last:border-0">
                        <td class="py-1.5 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" style="background-color: ${color}"></span>
                            <span class="font-semibold">${serviceName}</span>
                        </td>
                        <td class="py-1.5 text-right font-mono">${formatNumber(val)}</td>
                        <td class="py-1.5 text-right font-bold text-slate-400">${pct}</td>
                    </tr>
                `;
            });
            tableHTML += '</tbody>';
            tableEl.innerHTML = tableHTML;
        }

        function renderSlaMatrices() {
            const render = (id, f, l) => {
                const t = document.getElementById(id); t.innerHTML = '';
                const agg = {}; window.filteredData.forEach(d => { const k=d[f]; if(!agg[k]) agg[k]={u3:0,b35:0,o5:0,tot:0,sum:0}; agg[k].tot+=d._pcs; agg[k].sum+=(d._sla*d._pcs); if(d._sla<=2)agg[k].u3+=d._pcs; else if(d._sla<=5)agg[k].b35+=d._pcs; else agg[k].o5+=d._pcs; });
                let h = `<thead class="sticky top-0 bg-white z-10"><tr><th class="text-left text-slate-500">${l}</th><th class="text-center text-emerald-600 bg-emerald-50">0-2H</th><th class="text-center text-amber-600 bg-amber-50">3-5H</th><th class="text-center text-rose-600 bg-rose-50">>5H</th><th class="text-center text-slate-800 bg-slate-100">Tot</th><th class="text-center text-indigo-600 bg-indigo-50">Avg</th></tr></thead><tbody>`;
                Object.keys(agg).sort().forEach(k => { const d=agg[k]; h += `<tr class="hover:bg-slate-50"><td class="font-bold text-slate-700">${k}</td><td class="text-center text-emerald-600 font-mono">${formatNumber(d.u3)}</td><td class="text-center text-amber-600 font-mono">${formatNumber(d.b35)}</td><td class="text-center text-rose-600 font-bold font-mono">${formatNumber(d.o5)}</td><td class="text-center font-bold bg-slate-50 font-mono">${formatNumber(d.tot)}</td><td class="text-center font-bold text-indigo-600">${(d.tot>0?d.sum/d.tot:0).toFixed(1)}</td></tr>`; });
                t.innerHTML = h + '</tbody>';
            };
            render('slaOriginTable', '_origin', 'ORIGIN'); render('slaDestTable', '_dest', 'DESTINASI');
        }

        function changeMatrixPage(delta) {
             const dates = [...new Set(window.filteredData.map(d => d._date.getTime()))].sort((a,b)=>a-b);
             const totalPages = Math.ceil(dates.length / window.matrixRowsPerPage);
             const nextPage = window.matrixPage + delta;
             if(nextPage >= 1 && nextPage <= totalPages) {
                 window.matrixPage = nextPage;
                 renderMatrixTable();
             }
        }
        window.changeMatrixPage = changeMatrixPage;

        function renderMatrixTable() {
            const allDates = [...new Set(window.filteredData.map(d => d._date.getTime()))].sort((a,b)=>a-b);
            const dests = [...new Set(window.filteredData.map(d => d._dest))].sort();
            
            // Pagination Logic
            const totalPages = Math.ceil(allDates.length / window.matrixRowsPerPage) || 1;
            // Ensure current page is valid
            if (window.matrixPage > totalPages) window.matrixPage = 1;

            const start = (window.matrixPage - 1) * window.matrixRowsPerPage;
            const datesToRender = allDates.slice(start, start + window.matrixRowsPerPage);

            document.getElementById('matrixPageIndicator').innerText = `${window.matrixPage} / ${totalPages}`;

            const table = document.getElementById('matrixTable');
            let h = `<thead><tr><th class="text-left sticky left-0 bg-white z-10">Tanggal</th>`;
            dests.forEach(d => h += `<th class="text-center border-l border-slate-100">${d}</th>`);
            h += `<th class="text-center font-bold bg-slate-50 border-l border-slate-100">TOTAL</th></tr></thead><tbody>`;
            
            datesToRender.forEach(t => {
                const date = new Date(t); let rt = 0;
                let r = `<tr><td class="font-bold text-slate-700 sticky left-0 bg-white border-r border-slate-100 shadow-sm whitespace-nowrap">${formatDate(date)}</td>`;
                dests.forEach(dst => {
                    const v = window.filteredData.filter(d => d._date.getTime() === t && d._dest === dst).reduce((s,d) => s+d._pcs, 0); 
                    rt += v; r += `<td class="text-center border-r border-slate-50 ${v>0?'text-slate-800 font-medium':'text-slate-300'}">${v>0?formatNumber(v):'-'}</td>`;
                });
                h += r + `<td class="text-center font-bold text-slate-900 bg-slate-50">${formatNumber(rt)}</td></tr>`;
            });
            table.innerHTML = h + '</tbody>';
        }
        
        function changePage(delta) {
            const totalPages = Math.ceil(window.aggregatedData.length / window.rowsPerPage) || 1;
            const nextPage = window.currentPage + delta;
            if (nextPage >= 1 && nextPage <= totalPages) {
                window.currentPage = nextPage;
                aggregateAndRenderTable();
            }
        }
        window.changePage = changePage;

    </script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, getDocs, setDoc, doc, writeBatch, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAZFpX5OxSVIG7f58U60dVJHufHORFQuIg",
            authDomain: "hub-dashboard-92428.firebaseapp.com",
            projectId: "hub-dashboard-92428",
            storageBucket: "hub-dashboard-92428.firebasestorage.app",
            messagingSenderId: "827243064075",
            appId: "1:827243064075:web:9d7c41560e3da99833d00e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const statusText = document.getElementById('statusText');
                const connectionStatus = document.getElementById('connectionStatus');
                if(statusText) statusText.textContent = 'Connected';
                if(connectionStatus) connectionStatus.className = "w-1.5 h-1.5 rounded-full bg-emerald-500";
                loadDataFromFirestore();
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        async function loadDataFromFirestore() {
            try {
                showLoading(true, "Syncing...");
                const qs = await getDocs(collection(db, "inbound_data"));
                if (qs.empty) {
                    showLoading(false);
                    return; 
                }
                const docs = [];
                qs.forEach((doc) => {
                    const data = doc.data();
                    data._firestoreId = doc.id; 
                    docs.push(data);
                });
                
                if(window.processRawDataWrapper) {
                    window.processRawDataWrapper(docs);
                    document.getElementById('initialState').classList.add('hidden');
                    document.getElementById('dashboardContent').classList.remove('hidden');
                    showToast("Cloud Data Synced", "success");
                }
                showLoading(false);
            } catch (e) {
                console.error(e);
                showLoading(false);
            }
        }

        window.deleteDataForDate = async function(dateString) {
            showLoading(true, "Menghapus Data...");
            const targetDate = new Date(dateString);
            targetDate.setHours(0,0,0,0);

            const toDelete = window.rawData.filter(d => {
                const dDate = new Date(d._date);
                dDate.setHours(0,0,0,0);
                return dDate.getTime() === targetDate.getTime();
            });

            if(toDelete.length === 0) {
                showLoading(false);
                showToast("Tidak ada data tanggal tersebut", "info");
                return;
            }

            const batchSize = 450;
            let batches = [];
            let currentBatch = writeBatch(db);
            let count = 0;

            for (const item of toDelete) {
                if(item._firestoreId) {
                    const docRef = doc(db, "inbound_data", item._firestoreId);
                    currentBatch.delete(docRef);
                    count++;
                    if(count % batchSize === 0) {
                        batches.push(currentBatch.commit());
                        currentBatch = writeBatch(db);
                    }
                }
            }
            if(count % batchSize !== 0) batches.push(currentBatch.commit());

            try {
                await Promise.all(batches);
                showLoading(false);
                showToast(`Berhasil menghapus ${count} data`, "success");
                loadDataFromFirestore();
            } catch(e) {
                console.error(e);
                showLoading(false);
                showToast("Gagal menghapus data", "error");
            }
        };

        window.uploadCSVToFirestore = function(file) {
            showLoading(true, "Uploading...");
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: async function(results) {
                    const data = results.data;
                    const batchSize = 450; 
                    let batches = [];
                    let currentBatch = writeBatch(db);
                    let count = 0;
                    let skippedCount = 0;

                    const existingBagseals = new Set(window.rawData.map(d => String(d._mb).trim()));

                    for (const row of data) {
                        const bagseal = String(row['No Bagseals'] || '').trim();
                        
                        if (bagseal && existingBagseals.has(bagseal)) {
                            skippedCount++;
                            continue; 
                        }

                        const smu = (row['SMU']||'').replace(/\s/g, '');
                        const dest = (row['Destinasi']||'').replace(/\s/g, '');
                        const date = (row['Tanggal DIterima']||'').replace(/[\/\s,]/g, ''); 
                        const id = bagseal || `${smu}_${dest}_${date}`.substring(0, 100) || doc(collection(db, "inbound_data")).id; 

                        if (bagseal) existingBagseals.add(bagseal);

                        const docRef = doc(db, "inbound_data", id);
                        currentBatch.set(docRef, row);
                        count++;
                        if (count % batchSize === 0) { batches.push(currentBatch.commit()); currentBatch = writeBatch(db); }
                    }
                    if (count % batchSize !== 0) batches.push(currentBatch.commit());

                    try {
                        if (count > 0) {
                            await Promise.all(batches);
                            showLoading(false);
                            showToast(`Uploaded ${count} new. Skipped ${skippedCount}.`, "success");
                            loadDataFromFirestore();
                        } else {
                            showLoading(false);
                            showToast(`No new data. Skipped ${skippedCount}.`, "info");
                        }
                    } catch (e) {
                        console.error(e);
                        showLoading(false);
                        showToast("Upload Failed", "error");
                    }
                }
            });
        };
    </script>
</body>
</html>
